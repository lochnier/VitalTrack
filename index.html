<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VitalTrack â€” Health & Weight Tracker</title>
<meta name="theme-color" content="#0f1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVml0YWxUcmFjayIsInNob3J0X25hbWUiOiJWaXRhbFRyYWNrIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjExMTciLCJ0aGVtZV9jb2xvciI6IiMwZjExMTcifQ==">
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* ===== THEME ===== */
[data-theme="dark"] {
  --bg-primary:#0f1117;--bg-secondary:#1a1d27;--bg-card:#222538;--bg-card-hover:#2a2d42;
  --bg-input:#181b26;--border-subtle:#2e3148;--text-primary:#e8eaf0;--text-secondary:#8b8fa8;
  --text-muted:#5c6078;--shadow-card:0 2px 8px rgba(0,0,0,0.3);
}
[data-theme="light"] {
  --bg-primary:#f5f6fa;--bg-secondary:#ffffff;--bg-card:#ffffff;--bg-card-hover:#f0f1f5;
  --bg-input:#f0f1f5;--border-subtle:#dfe1e8;--text-primary:#1a1d27;--text-secondary:#5c6078;
  --text-muted:#8b8fa8;--shadow-card:0 2px 8px rgba(0,0,0,0.06);
}
:root {
  --bg-primary: #0f1117;
  --bg-secondary: #1a1d27;
  --bg-card: #222538;
  --bg-card-hover: #2a2d42;
  --bg-input: #181b26;
  --border-subtle: #2e3148;
  --text-primary: #e8eaf0;
  --text-secondary: #8b8fa8;
  --text-muted: #5c6078;
  --accent-blue: #4a7cff;
  --accent-green: #34d399;
  --accent-red: #f87171;
  --accent-purple: #a78bfa;
  --accent-amber: #fbbf24;
  --accent-cyan: #22d3ee;
  --accent-pink: #f472b6;
  --gradient-blue: linear-gradient(135deg, #4a7cff, #3b5ccc);
  --gradient-green: linear-gradient(135deg, #34d399, #059669);
  --gradient-red: linear-gradient(135deg, #f87171, #dc2626);
  --gradient-purple: linear-gradient(135deg, #a78bfa, #7c3aed);
  --gradient-amber: linear-gradient(135deg, #fbbf24, #d97706);
  --gradient-cyan: linear-gradient(135deg, #22d3ee, #0891b2);
  --gradient-pink: linear-gradient(135deg, #f472b6, #db2777);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  transition: background .3s, color .3s;
}
.mono { font-family: 'JetBrains Mono', monospace; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #3e4258; }

/* Layout */
.app-header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-subtle);
  position: sticky; top: 0; z-index: 50;
}
.tab-nav {
  display: flex; gap: 2px; overflow-x: auto;
  scrollbar-width: none; -ms-overflow-style: none;
}
.tab-nav::-webkit-scrollbar { display: none; }
.tab-btn {
  padding: 10px 16px; font-size: 13px; font-weight: 500;
  color: var(--text-secondary); white-space: nowrap;
  border-bottom: 2px solid transparent;
  transition: all 0.2s; cursor: pointer; background: none; border-top: none; border-left: none; border-right: none;
  display: flex; align-items: center; gap: 6px;
}
.tab-btn:hover { color: var(--text-primary); background: rgba(74,124,255,0.05); }
.tab-btn.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
.tab-badge {
  font-size: 10px; font-weight: 600; padding: 1px 6px;
  border-radius: 10px; background: rgba(74,124,255,0.15); color: var(--accent-blue);
}
.tab-content { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; }
.tab-content.active { display: block; }

/* Cards */
.card {
  background: var(--bg-card); border: 1px solid var(--border-subtle);
  border-radius: 12px; padding: 20px;
  transition: all 0.2s;
}
.card:hover { border-color: #3e4258; }
.stat-card {
  border-radius: 14px; padding: 20px; position: relative; overflow: hidden;
  cursor: pointer; transition: all 0.25s;
}
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
.stat-card .stat-value { font-size: 28px; font-weight: 700; line-height: 1.1; }
.stat-card .stat-label { font-size: 12px; opacity: 0.8; margin-top: 4px; }
.stat-card .stat-icon { position: absolute; top: 16px; right: 16px; font-size: 24px; opacity: 0.4; }

/* Forms */
input, select, textarea {
  background: var(--bg-input); border: 1px solid var(--border-subtle);
  color: var(--text-primary); border-radius: 8px; padding: 10px 14px;
  font-family: 'DM Sans', sans-serif; font-size: 14px; width: 100%;
  transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus {
  outline: none; border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(74,124,255,0.15);
}
label { font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

/* Buttons */
.btn {
  padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 13px;
  cursor: pointer; transition: all 0.2s; border: none; font-family: 'DM Sans', sans-serif;
  display: inline-flex; align-items: center; gap: 6px;
}
.btn-primary { background: var(--gradient-blue); color: white; }
.btn-primary:hover { box-shadow: 0 4px 12px rgba(74,124,255,0.4); transform: translateY(-1px); }
.btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-subtle); }
.btn-secondary:hover { background: var(--bg-card-hover); }
.btn-danger { background: var(--gradient-red); color: white; }
.btn-success { background: var(--gradient-green); color: white; }
.btn-sm { padding: 6px 12px; font-size: 12px; }

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
  z-index: 100; display: none; align-items: center; justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal {
  background: var(--bg-secondary); border: 1px solid var(--border-subtle);
  border-radius: 16px; padding: 28px; width: 90%; max-width: 600px;
  max-height: 85vh; overflow-y: auto; position: relative;
}
.modal-close {
  position: absolute; top: 16px; right: 16px; background: none; border: none;
  color: var(--text-secondary); cursor: pointer; font-size: 20px;
}
.modal-close:hover { color: var(--text-primary); }

/* Toast */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
.toast {
  padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 500;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4); animation: toastIn 0.3s ease;
  display: flex; align-items: center; gap: 8px;
}
.toast-success { background: #065f46; color: #6ee7b7; border: 1px solid #059669; }
.toast-error { background: #7f1d1d; color: #fca5a5; border: 1px solid #dc2626; }
.toast-info { background: #1e3a5f; color: #93c5fd; border: 1px solid #3b82f6; }
@keyframes toastIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* Table */
.data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.data-table thead th {
  padding: 10px 14px; font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.5px; color: var(--text-muted); text-align: left;
  border-bottom: 1px solid var(--border-subtle);
}
.data-table tbody td {
  padding: 12px 14px; font-size: 13px; border-bottom: 1px solid rgba(46,49,72,0.5);
}
.data-table tbody tr:hover { background: rgba(74,124,255,0.03); }
.data-table tbody tr { cursor: pointer; }

/* Search */
.search-bar {
  background: var(--bg-input); border: 1px solid var(--border-subtle);
  border-radius: 10px; padding: 10px 16px; display: flex; align-items: center; gap: 10px;
}
.search-bar input { background: none; border: none; padding: 0; box-shadow: none !important; }
.search-bar input:focus { box-shadow: none !important; }

/* Progress bar */
.progress-bar { background: var(--bg-input); border-radius: 8px; height: 8px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 8px; transition: width 0.5s ease; }

/* Fasting timer */
.timer-ring {
  width: 260px; height: 260px; position: relative; margin: 0 auto;
}
.timer-ring svg { transform: rotate(-90deg); }
.timer-ring .ring-bg { stroke: var(--border-subtle); fill: none; stroke-width: 8; }
.timer-ring .ring-progress { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1s ease; }
.timer-display {
  position: absolute; inset: 0; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.timer-display .time { font-size: 42px; font-weight: 700; letter-spacing: -1px; }
.timer-display .time-label { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

/* Meal status pills */
.meal-pill {
  padding: 8px 18px; border-radius: 24px; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.25s; border: 2px solid transparent;
}
.meal-pill.omad { background: rgba(52,211,153,0.1); color: var(--accent-green); border-color: rgba(52,211,153,0.3); }
.meal-pill.omad.selected { background: rgba(52,211,153,0.25); border-color: var(--accent-green); box-shadow: 0 0 16px rgba(52,211,153,0.2); }
.meal-pill.fasting { background: rgba(74,124,255,0.1); color: var(--accent-blue); border-color: rgba(74,124,255,0.3); }
.meal-pill.fasting.selected { background: rgba(74,124,255,0.25); border-color: var(--accent-blue); box-shadow: 0 0 16px rgba(74,124,255,0.2); }
.meal-pill.free { background: rgba(251,191,36,0.1); color: var(--accent-amber); border-color: rgba(251,191,36,0.3); }
.meal-pill.free.selected { background: rgba(251,191,36,0.25); border-color: var(--accent-amber); box-shadow: 0 0 16px rgba(251,191,36,0.2); }

/* GKI badge */
.gki-badge {
  display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
}
.gki-highest { background: rgba(220,38,38,0.15); color: #fca5a5; }
.gki-therapeutic { background: rgba(249,115,22,0.15); color: #fdba74; }
.gki-moderate { background: rgba(251,191,36,0.15); color: #fde68a; }
.gki-mild { background: rgba(52,211,153,0.15); color: #6ee7b7; }
.gki-none { background: rgba(107,114,128,0.15); color: #9ca3af; }

/* Responsive */
@media (max-width: 768px) {
  .tab-btn { padding: 8px 12px; font-size: 12px; }
  .tab-content { padding: 16px; }
  .stat-card .stat-value { font-size: 22px; }
  .timer-ring { width: 200px; height: 200px; }
  .timer-display .time { font-size: 32px; }
}

/* ===== SAMSUNG S24 / MOBILE OPTIMIZATIONS (â‰¤480px) ===== */
@media (max-width: 480px) {
  /* Header: stack compactly */
  .app-header .search-bar { display: none !important; }
  .app-header { padding: 0 !important; }
  .app-header > div { padding: 0 12px !important; }
  .app-header > div > div:first-child { padding: 10px 0 6px !important; }

  /* Hide export/save indicator text in header to save space */
  #autoSaveIndicator { display: none !important; }

  /* Tab content padding */
  .tab-content { padding: 12px 12px 90px !important; }

  /* Page titles */
  .tab-content h1 { font-size: 18px !important; }

  /* ---- Stat cards: 2-column grid ---- */
  .stat-cards-grid {
    grid-template-columns: 1fr 1fr !important;
    gap: 10px !important;
  }
  div[style*="minmax(180px"] {
    grid-template-columns: 1fr 1fr !important;
    gap: 10px !important;
  }
  .stat-card { padding: 14px !important; border-radius: 12px !important; }
  .stat-card .stat-value { font-size: 20px !important; }
  .stat-card .stat-label { font-size: 10px !important; }
  .stat-card .stat-icon { font-size: 18px !important; top: 10px; right: 10px; }

  /* ---- Summary cards (weight, exercise, etc.) ---- */
  div[style*="minmax(150px"] {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 8px !important;
  }

  /* ---- BMI + Goal Pace, Charts, Recent Activity: stack ---- */
  .dash-two-col {
    grid-template-columns: 1fr !important;
  }

  /* ---- Charts row: stack ---- */
  div[style*="grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:24px"],
  div[style*="grid-template-columns: 1fr 1fr; gap:16px;"] {
    grid-template-columns: 1fr !important;
  }

  /* ---- Recent Activity + Goal Progress: stack ---- */
  div[style*="grid-template-columns: 1fr 1fr; gap:16px"] {
    grid-template-columns: 1fr !important;
  }

  /* ---- Habits grid: 1 column ---- */
  #habitsGrid { grid-template-columns: 1fr !important; gap: 8px !important; }

  /* ---- Habits header: simplified ---- */
  #habitsWeekRow { flex-wrap: wrap; gap: 8px; }

  /* ---- Dashboard header buttons: wrap nicely ---- */
  .tab-content > div:first-child > div:last-child {
    flex-wrap: wrap;
    gap: 6px !important;
  }

  /* ---- Fasting: stack timer and meal status ---- */
  div[style*="grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:24px"] {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }

  /* Make timer ring smaller to fit phone */
  .timer-ring { width: 180px !important; height: 180px !important; }
  .timer-display .time { font-size: 28px !important; }

  /* Fasting presets: wrap */
  div[style*="justify-content:center"] .btn-sm { padding: 5px 8px !important; font-size: 11px !important; }

  /* ---- Fasting running totals: 1 column ---- */
  div[style*="grid-template-columns: repeat(3, 1fr)"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }

  /* ---- GKI reference: 1 column ---- */
  div[style*="minmax(200px"] {
    grid-template-columns: 1fr 1fr !important;
    gap: 8px !important;
  }

  /* ---- Cards: smaller padding ---- */
  .card { padding: 14px !important; border-radius: 10px !important; }

  /* ---- Tables: horizontal scroll with hint ---- */
  .data-table thead th { padding: 8px 10px !important; font-size: 10px !important; }
  .data-table tbody td { padding: 10px 10px !important; font-size: 12px !important; }

  /* ---- Buttons: better touch targets ---- */
  .btn { padding: 10px 14px !important; font-size: 13px !important; }
  .btn-sm { padding: 8px 12px !important; font-size: 12px !important; }

  /* ---- Modal: full-width on mobile ---- */
  .modal { width: 96% !important; padding: 20px !important; border-radius: 14px !important; max-height: 90vh !important; }

  /* ---- Mobile nav: bigger icons ---- */
  .mobile-tab { padding: 5px 6px !important; font-size: 9px !important; min-width: 40px !important; }
  .mobile-tab span { font-size: 20px !important; }

  /* ---- Habit cards ---- */
  .habit-card { padding: 12px !important; }

  /* ---- Water glasses: bigger tap targets ---- */
  .water-glass { width: 42px !important; height: 42px !important; font-size: 18px !important; }

  /* ---- Meal pills: wrap ---- */
  #mealStatusPills { flex-wrap: wrap !important; gap: 8px !important; justify-content: center !important; }
  .meal-pill { padding: 10px 14px !important; font-size: 13px !important; }

  /* ---- Search: hide in header, moved to mobile search icon ---- */
  .search-bar { width: 100% !important; }

  /* ---- Overall streak ring ---- */
  .overall-ring { width: 100px !important; height: 100px !important; }

  /* ---- Toast: full width on small screens ---- */
  .toast-container { left: 12px !important; right: 12px !important; top: auto !important; bottom: 80px !important; }
  .toast { width: 100% !important; }

  /* ---- Misc layout fixes ---- */
  .card canvas { max-height: 200px; }
  input, select, textarea { font-size: 16px !important; } /* Prevents iOS/Android zoom on focus */

  /* Mobile search button & export label */
  .mobile-search-btn { display: flex !important; }
  .hide-xs { display: none !important; }

  /* Dashboard quick action buttons */
  .dash-quick-btns { flex-wrap: wrap; gap: 6px !important; justify-content: flex-end; }
  .dash-quick-btns .btn-sm { font-size: 11px !important; padding: 7px 10px !important; }

  /* Fasting top grid: stack */
  .fasting-top-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
}

/* Animations */
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.animate-in { animation: fadeIn 0.3s ease forwards; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.pulse { animation: pulse 2s ease-in-out infinite; }

/* Habit Cards */
.habit-card {
  background: var(--bg-card); border: 1px solid var(--border-subtle);
  border-radius: 12px; padding: 16px; cursor: pointer;
  transition: all 0.25s; user-select: none; position: relative; overflow: hidden;
}
.habit-card:hover { border-color: #3e4258; transform: translateY(-1px); }
.habit-card.checked {
  border-color: rgba(52,211,153,0.4);
  background: linear-gradient(135deg, rgba(52,211,153,0.08), rgba(52,211,153,0.02));
}
.habit-card.checked .habit-check {
  background: var(--accent-green); border-color: var(--accent-green); color: white;
}
.habit-check {
  width: 28px; height: 28px; border-radius: 8px; border: 2px solid var(--border-subtle);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; transition: all 0.25s; flex-shrink: 0;
}
.habit-streak-badge {
  font-size: 11px; font-weight: 700; padding: 2px 8px;
  border-radius: 6px; display: inline-flex; align-items: center; gap: 3px;
}
.streak-fire { background: rgba(251,191,36,0.15); color: var(--accent-amber); }
.streak-none { background: var(--bg-input); color: var(--text-muted); }

/* Habit week grid */
.habit-week {
  display: flex; gap: 3px; margin-top: 8px;
}
.habit-week-dot {
  width: 18px; height: 18px; border-radius: 4px; font-size: 8px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 600; color: var(--text-muted);
}
.habit-week-dot.done { background: rgba(52,211,153,0.25); color: var(--accent-green); }
.habit-week-dot.missed { background: rgba(248,113,113,0.1); color: rgba(248,113,113,0.4); }
.habit-week-dot.future { background: var(--bg-input); color: var(--text-muted); }
.habit-week-dot.today { border: 1px solid var(--accent-blue); }

/* Overall streak ring */
.overall-ring {
  width: 120px; height: 120px; position: relative; margin: 0 auto;
}
.overall-ring svg { transform: rotate(-90deg); }
.overall-ring .ring-text {
  position: absolute; inset: 0; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.overall-ring .ring-pct { font-size: 28px; font-weight: 700; }
.overall-ring .ring-lbl { font-size: 10px; color: var(--text-secondary); }

/* Settings habit list */
.habit-list-item {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 14px; background: var(--bg-input);
  border-radius: 8px; transition: background 0.2s;
}
.habit-list-item:hover { background: var(--bg-card-hover); }

/* Drag-and-drop */
.habit-list-item[draggable="true"]{cursor:grab}
.habit-list-item.dragging{opacity:.4;cursor:grabbing}
.habit-list-item.drag-over{border-top:2px solid var(--accent-blue)}

/* Checkmark animation */
@keyframes checkPop{0%{transform:scale(.3);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
@keyframes checkRipple{0%{box-shadow:0 0 0 0 rgba(52,211,153,.4)}100%{box-shadow:0 0 0 16px rgba(52,211,153,0)}}
.habit-card.just-checked .habit-check{animation:checkPop .35s cubic-bezier(.4,0,.2,1)}
.habit-card.just-checked{animation:checkRipple .5s ease-out}

/* Water tracker */
.water-glass{width:38px;height:38px;border-radius:8px;border:2px solid var(--border-subtle);display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;transition:all .25s;user-select:none}
.water-glass.filled{background:rgba(34,211,238,.15);border-color:rgba(34,211,238,.4);color:var(--accent-cyan)}
.water-glass:hover{transform:scale(1.1);border-color:var(--accent-cyan)}

/* BMI gauge */
.bmi-gauge{position:relative;width:100%;height:24px;border-radius:12px;overflow:hidden;background:linear-gradient(90deg,#34d399 0%,#34d399 25%,#fbbf24 25%,#fbbf24 50%,#f87171 50%,#f87171 75%,#dc2626 75%)}
.bmi-marker{position:absolute;top:-4px;width:4px;height:32px;background:white;border-radius:2px;transition:left .5s;box-shadow:0 0 6px rgba(0,0,0,.5)}

/* Milestone badges */
.badge{display:inline-flex;align-items:center;gap:6px;padding:7px 12px;border-radius:10px;font-size:11px;font-weight:600;border:1px solid var(--border-subtle);background:var(--bg-input)}
.badge.earned{border-color:rgba(251,191,36,.4);background:linear-gradient(135deg,rgba(251,191,36,.08),rgba(251,191,36,.02))}
.badge.locked{opacity:.35;filter:grayscale(1)}
.badge-icon{font-size:16px}

/* Mobile bottom nav */
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border-subtle);z-index:60;padding:4px 4px calc(4px + env(safe-area-inset-bottom));overflow-x:auto;-webkit-overflow-scrolling:touch}
.mobile-nav-inner{display:flex;gap:2px;justify-content:space-around;min-width:max-content}
.mobile-tab{display:flex;flex-direction:column;align-items:center;padding:4px 8px;font-size:9px;color:var(--text-muted);border:none;background:none;cursor:pointer;border-radius:8px;white-space:nowrap;min-width:46px}
.mobile-tab.active{color:var(--accent-blue);background:rgba(74,124,255,.08)}
.mobile-tab span{font-size:18px;line-height:1}

/* Responsive overrides */
@media(max-width:768px){
  .desktop-tabs{display:none!important}
  .mobile-nav{display:block!important}
  .tab-content{padding:14px;padding-bottom:80px}
  body{padding-bottom:70px}
}
@media(min-width:769px){.mobile-nav{display:none!important}}

/* Print */
@media print{
  .app-header,.mobile-nav,.btn,.toast-container,.modal-overlay{display:none!important}
  body{background:white!important;color:black!important;padding:0!important}
  .tab-content{display:block!important;padding:10px!important}
  .card{box-shadow:none!important;border:1px solid #ddd!important;background:white!important}
  .stat-card{-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
</style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Header -->
<header class="app-header">
  <div style="max-width:1400px; margin:0 auto; padding: 0 24px;">
    <div style="display:flex; align-items:center; justify-content:space-between; padding: 14px 0 0;">
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="width:32px;height:32px;border-radius:8px;background:var(--gradient-blue);display:flex;align-items:center;justify-content:center;font-size:16px;">âš¡</div>
        <div>
          <div style="font-size:16px;font-weight:700;letter-spacing:-0.3px;">VitalTrack</div>
          <div style="font-size:10px;color:var(--text-muted);">Health & Weight Tracker</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <div class="search-bar" style="width:260px;">
          <span style="color:var(--text-muted);">ğŸ”</span>
          <input type="text" id="globalSearch" placeholder="Search everything... (Ctrl+K)" style="font-size:13px;">
        </div>
        <!-- Mobile search button (shown only on small screens) -->
        <button class="btn btn-sm btn-secondary mobile-search-btn" onclick="const q=prompt('Search VitalTrack:');if(q)globalSearch(q);" title="Search" style="display:none;padding:7px 10px;">ğŸ”</button>
        <button class="btn btn-success btn-sm" onclick="exportExcel()" title="Export to Excel" style="padding:7px 12px;">ğŸ“Š <span class="hide-xs">Export</span></button>
        <button class="btn btn-sm btn-secondary" onclick="toggleTheme()" id="themeToggleBtn" title="Toggle theme" style="padding:7px 10px;">ğŸŒ™</button>
        <div id="autoSaveIndicator" style="font-size:10px;color:var(--text-muted);white-space:nowrap;">â—  Saved</div>
      </div>
    </div>
    <nav class="tab-nav desktop-tabs" id="tabNav">
      <button class="tab-btn active" data-tab="dashboard">ğŸ“Š Dashboard</button>
      <button class="tab-btn" data-tab="weight">âš–ï¸ Weight <span class="tab-badge" id="weightCount">0</span></button>
      <button class="tab-btn" data-tab="glucose">ğŸ©¸ Glucose <span class="tab-badge" id="glucoseCount">0</span></button>
      <button class="tab-btn" data-tab="exercise">ğŸƒ Exercise <span class="tab-badge" id="exerciseCount">0</span></button>
      <button class="tab-btn" data-tab="fasting">ğŸ• Fasting <span class="tab-badge" id="fastingCount">0</span></button>
      <button class="tab-btn" data-tab="water">ğŸ’§ Water</button>
      <button class="tab-btn" data-tab="goals">ğŸ¯ Goals</button>
      <button class="tab-btn" data-tab="journal">ğŸ““ Journal <span class="tab-badge" id="journalCount">0</span></button>
      <button class="tab-btn" data-tab="reports">ğŸ“ˆ Reports</button>
      <button class="tab-btn" data-tab="settings">âš™ï¸ Settings</button>
    </nav>
  </div>
</header>

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-nav"><div class="mobile-nav-inner">
  <button class="mobile-tab active" data-tab="dashboard"><span>ğŸ“Š</span>Home</button>
  <button class="mobile-tab" data-tab="weight"><span>âš–ï¸</span>Weight</button>
  <button class="mobile-tab" data-tab="glucose"><span>ğŸ©¸</span>Glucose</button>
  <button class="mobile-tab" data-tab="exercise"><span>ğŸƒ</span>Exercise</button>
  <button class="mobile-tab" data-tab="fasting"><span>ğŸ•</span>Fast</button>
  <button class="mobile-tab" data-tab="water"><span>ğŸ’§</span>Water</button>
  <button class="mobile-tab" data-tab="goals"><span>ğŸ¯</span>Goals</button>
  <button class="mobile-tab" data-tab="journal"><span>ğŸ““</span>Journal</button>
  <button class="mobile-tab" data-tab="reports"><span>ğŸ“ˆ</span>Reports</button>
  <button class="mobile-tab" data-tab="settings"><span>âš™ï¸</span>Settings</button>
</div></nav>

<!-- ==================== DASHBOARD TAB ==================== -->
<div class="tab-content active" id="tab-dashboard">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <div>
      <h1 style="font-size:22px;font-weight:700;">Daily Dashboard</h1>
      <p style="font-size:13px;color:var(--text-secondary);" id="dashDateLabel"></p>
    </div>
    <div class="dash-quick-btns" style="display:flex;gap:8px;">
      <button class="btn btn-primary btn-sm" onclick="openWeightModal()">+ Weight</button>
      <button class="btn btn-secondary btn-sm" onclick="openGlucoseModal()">+ Glucose</button>
      <button class="btn btn-secondary btn-sm" onclick="openExerciseModal()">+ Exercise</button>
    </div>
  </div>

  <!-- Weekly Digest (Monday) -->
  <div class="card" id="weeklyDigest" style="display:none;margin-bottom:20px;border-left:3px solid var(--accent-purple);padding:20px;"></div>

  <!-- Milestones Banner -->
  <div id="milestoneBanner" style="margin-bottom:16px;display:flex;flex-wrap:wrap;gap:8px;"></div>

  <!-- Healthy Habits Section -->
  <div class="card" style="margin-bottom:24px;padding:24px;border: 1px solid rgba(52,211,153,0.15);background: linear-gradient(180deg, rgba(52,211,153,0.03) 0%, var(--bg-card) 100%);">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:32px;height:32px;border-radius:8px;background:var(--gradient-green);display:flex;align-items:center;justify-content:center;font-size:16px;">âœ…</div>
        <div>
          <h2 style="font-size:16px;font-weight:700;">Healthy Habits</h2>
          <div style="font-size:11px;color:var(--text-secondary);" id="habitsSubtitle">Check off what you've done today</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <!-- Date Navigator -->
        <div style="display:flex;align-items:center;gap:3px;background:var(--bg-input);border-radius:8px;padding:3px;">
          <button class="btn btn-sm btn-secondary" onclick="navHabitDate(-1)" style="padding:4px 8px;font-size:14px;">â†</button>
          <button class="btn btn-sm btn-secondary" onclick="navHabitDate(0)" id="habitDateBtn" style="padding:4px 10px;font-size:11px;min-width:80px;">Today</button>
          <button class="btn btn-sm btn-secondary" onclick="navHabitDate(1)" style="padding:4px 8px;font-size:14px;">â†’</button>
        </div>
        <div style="width:48px;height:48px;position:relative;">
          <svg width="48" height="48" viewBox="0 0 48 48" style="transform:rotate(-90deg);"><circle cx="24" cy="24" r="19" fill="none" stroke="var(--border-subtle)" stroke-width="4"/><circle id="habitsRingProgress" cx="24" cy="24" r="19" fill="none" stroke="var(--accent-green)" stroke-width="4" stroke-linecap="round" stroke-dasharray="119.4" stroke-dashoffset="119.4" style="transition:stroke-dashoffset .6s ease"/></svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;" id="habitsPctText">0%</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="switchTab('settings')" title="Manage habits">âš™ï¸</button>
      </div>
    </div>

    <!-- Habits Grid -->
    <div id="habitsGrid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));gap:10px;">
      <!-- Populated by JS -->
    </div>

    <!-- No habits message -->
    <div id="noHabitsMsg" style="display:none;text-align:center;padding:24px;color:var(--text-secondary);">
      <div style="font-size:24px;margin-bottom:8px;">ğŸ¯</div>
      <div style="font-size:13px;">No habits configured yet.</div>
      <button class="btn btn-primary btn-sm" style="margin-top:10px;" onclick="switchTab('settings')">Add Habits in Settings</button>
    </div>

    <!-- Weekly Overview Row -->
    <div id="habitsWeekRow" style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center;">
      <div style="font-size:12px;color:var(--text-muted);font-weight:600;">7-Day Overview</div>
      <div id="habitsWeekSummary" style="display:flex;gap:4px;"></div>
      <div style="font-size:12px;">
        <span style="color:var(--text-muted);">Best streak:</span>
        <span style="color:var(--accent-amber);font-weight:700;" id="habitsBestStreak">0 days</span>
      </div>
    </div>
  </div>

  <!-- Stat Cards Row -->
  <div class="stat-cards-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:14px; margin-bottom:24px;">
    <div class="stat-card" style="background:var(--gradient-blue);color:white;" onclick="switchTab('weight')">
      <div class="stat-icon">âš–ï¸</div>
      <div class="stat-value" id="dashCurrentWeight">â€”</div>
      <div class="stat-label">Current Weight (lbs)</div>
    </div>
    <div class="stat-card" style="background:var(--gradient-green);color:white;" onclick="switchTab('weight')">
      <div class="stat-icon">ğŸ“‰</div>
      <div class="stat-value" id="dashTotalLoss">â€”</div>
      <div class="stat-label">Total Loss (lbs)</div>
    </div>
    <div class="stat-card" style="background:var(--gradient-purple);color:white;" onclick="switchTab('weight')">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-value" id="dashBMI">â€”</div>
      <div class="stat-label">Current BMI</div>
    </div>
    <div class="stat-card" style="background:var(--gradient-amber);color:white;" onclick="switchTab('glucose')">
      <div class="stat-icon">ğŸ©¸</div>
      <div class="stat-value" id="dashGlucose">â€”</div>
      <div class="stat-label">Last Glucose (mg/dL)</div>
    </div>
    <div class="stat-card" style="background:var(--gradient-cyan);color:white;" onclick="switchTab('exercise')">
      <div class="stat-icon">ğŸ‘Ÿ</div>
      <div class="stat-value" id="dashSteps">â€”</div>
      <div class="stat-label">Last Steps</div>
    </div>
    <div class="stat-card" style="background:var(--gradient-pink);color:white;" onclick="switchTab('fasting')">
      <div class="stat-icon">ğŸ”¥</div>
      <div class="stat-value" id="dashFastStreak">0</div>
      <div class="stat-label">Fasting Streak (days)</div>
    </div>
  </div>

  <!-- BMI Gauge + Goal Pace Row -->
  <div class="dash-two-col" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
    <div class="card">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:12px;">BMI Category</h3>
      <div class="bmi-gauge"><div class="bmi-marker" id="bmiMarker" style="left:50%;"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted);margin-top:4px;"><span>Under 18.5</span><span>Normal 18.5-24.9</span><span>Over 25-29.9</span><span>Obese 30+</span></div>
      <div style="text-align:center;margin-top:10px;font-size:13px;"><span id="bmiValue" style="font-weight:700;font-size:20px;">â€”</span> <span id="bmiCategory" style="color:var(--text-secondary);"></span></div>
    </div>
    <div class="card">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:12px;">ğŸ“… Goal Pace</h3>
      <div id="goalPaceContent" style="text-align:center;padding:10px;"><div style="color:var(--text-secondary);font-size:13px;">Add weight data to see pace</div></div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="dash-two-col" style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:24px;">
    <div class="card">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Weight Trend</h3>
      <canvas id="dashWeightChart" height="180"></canvas>
    </div>
    <div class="card">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Body Composition</h3>
      <canvas id="dashBodyCompChart" height="180"></canvas>
    </div>
  </div>

  <!-- Recent Activity & Goals -->
  <div class="dash-two-col" style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
    <div class="card">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Recent Activity</h3>
      <div id="dashRecentActivity" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
    <div class="card">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Goal Progress</h3>
      <div id="dashGoalProgress"></div>
    </div>
  </div>
</div>

<!-- ==================== WEIGHT TAB ==================== -->
<div class="tab-content" id="tab-weight">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <h1 style="font-size:22px;font-weight:700;">Weight & Body Composition</h1>
    <button class="btn btn-primary" onclick="openWeightModal()">+ New Entry</button>
  </div>

  <!-- Weight Summary Cards -->
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:20px;">
    <div class="card" style="text-align:center;padding:14px;cursor:pointer;position:relative;" onclick="openWeightGoalsModal()">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Starting Weight</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-blue);" id="weightStarting">â€”</div>
      <div style="position:absolute;top:8px;right:10px;font-size:11px;color:var(--text-muted);">âœï¸</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Current</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-green);" id="weightCurrent">â€”</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Total Lost</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-green);" id="weightLost">â€”</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;cursor:pointer;position:relative;" onclick="openWeightGoalsModal()">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Goal Weight</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-purple);" id="weightGoalDisp">â€”</div>
      <div style="position:absolute;top:8px;right:10px;font-size:11px;color:var(--text-muted);">âœï¸</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;cursor:pointer;position:relative;" onclick="openWeightGoalsModal()">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Lbs to Lose</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-red);" id="weightToLose">â€”</div>
      <div style="position:absolute;top:8px;right:10px;font-size:11px;color:var(--text-muted);">âœï¸</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Remaining</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-amber);" id="weightRemaining">â€”</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Avg Loss/Day</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-cyan);" id="weightAvgLoss">â€”</div>
    </div>
  </div>

  <!-- Weight Chart -->
  <div class="card" style="margin-bottom:20px;">
    <canvas id="weightTrendChart" height="200"></canvas>
  </div>

  <!-- Weight Table -->
  <div class="card" style="overflow-x:auto;">
    <table class="data-table" id="weightTable">
      <thead>
        <tr>
          <th>Date</th><th>Weight</th><th>Change</th><th>BMI</th><th>Body Fat %</th>
          <th>Subcutaneous</th><th>Visceral</th><th>Water %</th><th>Muscle %</th>
          <th>Muscle Mass</th><th>Bone</th><th>Protein %</th><th>BMR</th><th>Met. Age</th><th>Notes</th><th></th>
        </tr>
      </thead>
      <tbody id="weightTableBody"></tbody>
    </table>
  </div>
</div>

<!-- ==================== GLUCOSE TAB ==================== -->
<div class="tab-content" id="tab-glucose">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <h1 style="font-size:22px;font-weight:700;">Glucose & Ketones</h1>
    <button class="btn btn-primary" onclick="openGlucoseModal()">+ New Reading</button>
  </div>

  <!-- GKI Reference -->
  <div class="card" style="margin-bottom:20px;">
    <h3 style="font-size:14px;font-weight:600;margin-bottom:12px;">GKI Reference Guide</h3>
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
      <div style="padding:10px;border-radius:8px;background:rgba(220,38,38,0.08);border:1px solid rgba(220,38,38,0.2);">
        <div class="gki-badge gki-highest" style="margin-bottom:4px;">&lt; 1.0</div>
        <div style="font-size:12px;font-weight:600;">Highest Therapeutic</div>
        <div style="font-size:11px;color:var(--text-secondary);">Requires medical supervision</div>
      </div>
      <div style="padding:10px;border-radius:8px;background:rgba(249,115,22,0.08);border:1px solid rgba(249,115,22,0.2);">
        <div class="gki-badge gki-therapeutic" style="margin-bottom:4px;">1.0 â€“ 3.0</div>
        <div style="font-size:12px;font-weight:600;">Therapeutic Ketosis</div>
        <div style="font-size:11px;color:var(--text-secondary);">Cancer/neurological management</div>
      </div>
      <div style="padding:10px;border-radius:8px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);">
        <div class="gki-badge gki-moderate" style="margin-bottom:4px;">3.0 â€“ 6.0</div>
        <div style="font-size:12px;font-weight:600;">Moderate Ketosis</div>
        <div style="font-size:11px;color:var(--text-secondary);">Diabetes/insulin resistance</div>
      </div>
      <div style="padding:10px;border-radius:8px;background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.2);">
        <div class="gki-badge gki-mild" style="margin-bottom:4px;">6.0 â€“ 9.0</div>
        <div style="font-size:12px;font-weight:600;">Mild Ketosis</div>
        <div style="font-size:11px;color:var(--text-secondary);">Weight loss & optimal health</div>
      </div>
      <div style="padding:10px;border-radius:8px;background:rgba(107,114,128,0.08);border:1px solid rgba(107,114,128,0.2);">
        <div class="gki-badge gki-none" style="margin-bottom:4px;">&gt; 9.0</div>
        <div style="font-size:12px;font-weight:600;">Not in Ketosis</div>
        <div style="font-size:11px;color:var(--text-secondary);">Standard metabolic state</div>
      </div>
    </div>
  </div>

  <!-- Glucose Chart -->
  <div class="card" style="margin-bottom:20px;">
    <canvas id="glucoseChart" height="200"></canvas>
  </div>

  <!-- Glucose Table -->
  <div class="card" style="overflow-x:auto;">
    <table class="data-table">
      <thead>
        <tr><th>Date</th><th>Time</th><th>Glucose</th><th>Ketones</th><th>GKI</th><th>Category</th><th>Notes</th><th></th></tr>
      </thead>
      <tbody id="glucoseTableBody"></tbody>
    </table>
  </div>
</div>

<!-- ==================== EXERCISE TAB ==================== -->
<div class="tab-content" id="tab-exercise">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <h1 style="font-size:22px;font-weight:700;">Exercise & Activity</h1>
    <button class="btn btn-primary" onclick="openExerciseModal()">+ New Entry</button>
  </div>

  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:20px;">
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Total Steps</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-blue);" id="exTotalSteps">â€”</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Total Miles</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-green);" id="exTotalMiles">â€”</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Avg Heart Rate</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-red);" id="exAvgHR">â€”</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Resting HR</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-pink);" id="exRestHR">â€”</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">VO2 Max</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent-cyan);" id="exVO2">â€”</div>
    </div>
  </div>

  <div class="card" style="margin-bottom:20px;">
    <canvas id="exerciseChart" height="200"></canvas>
  </div>

  <div class="card" style="overflow-x:auto;">
    <table class="data-table">
      <thead>
        <tr><th>Date</th><th>Steps</th><th>Miles</th><th>Avg HR</th><th>Î” HR</th><th>Rest HR</th><th>Î” Rest</th><th>VO2 Max</th><th>Notes</th><th></th></tr>
      </thead>
      <tbody id="exerciseTableBody"></tbody>
    </table>
  </div>
</div>

<!-- ==================== FASTING TAB ==================== -->
<div class="tab-content" id="tab-fasting">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <h1 style="font-size:22px;font-weight:700;">Fasting Tracker</h1>
    <button class="btn btn-primary" onclick="openFastingModal()">+ Log Day</button>
  </div>

  <!-- Fasting Timer -->
  <div class="fasting-top-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:24px;">
    <div class="card" style="text-align:center;padding:30px;">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:20px;">Fasting Timer</h3>
      <div class="timer-ring" id="timerRing">
        <svg width="100%" height="100%" viewBox="0 0 260 260">
          <circle class="ring-bg" cx="130" cy="130" r="116"/>
          <circle class="ring-progress" id="timerProgress" cx="130" cy="130" r="116"
            stroke="url(#timerGrad)" stroke-dasharray="729.2" stroke-dashoffset="729.2"/>
          <defs>
            <linearGradient id="timerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#4a7cff"/>
              <stop offset="100%" style="stop-color:#34d399"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="timer-display">
          <div class="time mono" id="timerTime">00:00:00</div>
          <div class="time-label" id="timerLabel">Not Active</div>
        </div>
      </div>
      <div style="margin-top:20px;display:flex;gap:8px;justify-content:center;align-items:center;">
        <label style="margin-bottom:0;font-size:12px;">Duration (hrs):</label>
        <input type="number" id="fastHours" value="16" min="1" max="72" style="width:70px;text-align:center;">
        <button class="btn btn-primary btn-sm" id="fastStartBtn" onclick="toggleFastTimer()">â–¶ Start</button>
        <button class="btn btn-secondary btn-sm" onclick="resetFastTimer()">â†º Reset</button>
      </div>
      <div style="margin-top:12px;display:flex;gap:6px;justify-content:center;">
        <button class="btn btn-secondary btn-sm" onclick="setFastPreset(16)">16h</button>
        <button class="btn btn-secondary btn-sm" onclick="setFastPreset(18)">18h</button>
        <button class="btn btn-secondary btn-sm" onclick="setFastPreset(20)">20h</button>
        <button class="btn btn-secondary btn-sm" onclick="setFastPreset(24)">24h</button>
        <button class="btn btn-secondary btn-sm" onclick="setFastPreset(36)">36h</button>
        <button class="btn btn-secondary btn-sm" onclick="setFastPreset(48)">48h</button>
        <button class="btn btn-secondary btn-sm" onclick="setFastPreset(72)">72h</button>
      </div>
    </div>

    <!-- Today's Meal Status -->
    <div class="card" style="padding:30px;">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:20px;">Today's Meal Status</h3>
      <div style="display:flex;gap:12px;justify-content:center;margin-bottom:24px;" id="mealStatusPills">
        <div class="meal-pill omad" onclick="setMealStatus('OMAD')">ğŸ½ OMAD</div>
        <div class="meal-pill fasting" onclick="setMealStatus('Fasting')">â³ Fasting</div>
        <div class="meal-pill free" onclick="setMealStatus('Free Day')">ğŸ‰ Free Day</div>
      </div>
      <div id="todayMealInfo" style="text-align:center;">
        <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Select today's meal plan above</div>
      </div>

      <!-- Streak & Stats -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:20px;">
        <div style="text-align:center;padding:12px;background:var(--bg-input);border-radius:10px;">
          <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Fasting Streak</div>
          <div style="font-size:24px;font-weight:700;color:var(--accent-blue);" id="fastingStreak">0</div>
          <div style="font-size:10px;color:var(--text-secondary);">days</div>
        </div>
        <div style="text-align:center;padding:12px;background:var(--bg-input);border-radius:10px;">
          <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">OMAD Days</div>
          <div style="font-size:24px;font-weight:700;color:var(--accent-green);" id="omadCount">0</div>
          <div style="font-size:10px;color:var(--text-secondary);">this month</div>
        </div>
        <div style="text-align:center;padding:12px;background:var(--bg-input);border-radius:10px;">
          <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Free Days</div>
          <div style="font-size:24px;font-weight:700;color:var(--accent-amber);" id="freeDayCount">0</div>
          <div style="font-size:10px;color:var(--text-secondary);">this month</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Running Totals -->
  <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; margin-bottom:24px;">
    <div class="card" style="padding:18px;border-left:3px solid var(--accent-green);">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Total OMAD Days</div>
          <div style="font-size:32px;font-weight:700;color:var(--accent-green);margin-top:4px;" id="totalOmadAll">0</div>
        </div>
        <div style="font-size:28px;opacity:0.3;">ğŸ½</div>
      </div>
      <div style="margin-top:8px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;">
        <span>This month: <strong id="totalOmadMonth" style="color:var(--accent-green);">0</strong></span>
        <span>This week: <strong id="totalOmadWeek" style="color:var(--accent-green);">0</strong></span>
      </div>
    </div>
    <div class="card" style="padding:18px;border-left:3px solid var(--accent-blue);">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Total Fasting Days</div>
          <div style="font-size:32px;font-weight:700;color:var(--accent-blue);margin-top:4px;" id="totalFastingAll">0</div>
        </div>
        <div style="font-size:28px;opacity:0.3;">â³</div>
      </div>
      <div style="margin-top:8px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;">
        <span>This month: <strong id="totalFastingMonth" style="color:var(--accent-blue);">0</strong></span>
        <span>This week: <strong id="totalFastingWeek" style="color:var(--accent-blue);">0</strong></span>
      </div>
    </div>
    <div class="card" style="padding:18px;border-left:3px solid var(--accent-amber);">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Total Free Days</div>
          <div style="font-size:32px;font-weight:700;color:var(--accent-amber);margin-top:4px;" id="totalFreeAll">0</div>
        </div>
        <div style="font-size:28px;opacity:0.3;">ğŸ‰</div>
      </div>
      <div style="margin-top:8px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;">
        <span>This month: <strong id="totalFreeMonth" style="color:var(--accent-amber);">0</strong></span>
        <span>This week: <strong id="totalFreeWeek" style="color:var(--accent-amber);">0</strong></span>
      </div>
    </div>
  </div>

  <!-- Fasting Log Table -->
  <div class="card" style="overflow-x:auto;">
    <h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Fasting History</h3>
    <table class="data-table">
      <thead>
        <tr><th>Date</th><th>Status</th><th>Fast Duration (hrs)</th><th>Completed</th><th>Notes</th><th></th></tr>
      </thead>
      <tbody id="fastingTableBody"></tbody>
    </table>
  </div>
</div>

<!-- ==================== WATER TAB ==================== -->
<div class="tab-content" id="tab-water">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <h1 style="font-size:22px;font-weight:700;">ğŸ’§ Water Intake</h1>
    <div style="display:flex;align-items:center;gap:8px;">
      <label style="margin-bottom:0;font-size:12px;">Daily Goal (oz):</label>
      <input type="number" id="waterGoalInput" value="128" min="8" max="256" style="width:70px;text-align:center;" onchange="saveWaterGoal()">
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
    <div class="card" style="text-align:center;padding:30px;">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:16px;">Today's Intake</h3>
      <div style="position:relative;width:160px;height:160px;margin:0 auto;">
        <svg width="160" height="160" viewBox="0 0 160 160" style="transform:rotate(-90deg);"><circle cx="80" cy="80" r="70" fill="none" stroke="var(--border-subtle)" stroke-width="10"/><circle id="waterRingProgress" cx="80" cy="80" r="70" fill="none" stroke="var(--accent-cyan)" stroke-width="10" stroke-linecap="round" stroke-dasharray="439.8" stroke-dashoffset="439.8" style="transition:stroke-dashoffset .6s ease"/></svg>
        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
          <div style="font-size:36px;font-weight:700;color:var(--accent-cyan);" id="waterOzDisplay">0</div>
          <div style="font-size:12px;color:var(--text-secondary);" id="waterGoalLabel">of 128 oz</div>
        </div>
      </div>
      <div style="margin-top:20px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
        <button class="btn btn-sm btn-primary" onclick="addWater(8)">+8 oz</button>
        <button class="btn btn-sm btn-primary" onclick="addWater(16)">+16 oz</button>
        <button class="btn btn-sm btn-primary" onclick="addWater(32)">+32 oz</button>
        <button class="btn btn-sm btn-secondary" onclick="addWater(-8)">âˆ’8 oz</button>
      </div>
      <div id="waterGlasses" style="display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-top:16px;"></div>
    </div>
    <div class="card" style="padding:30px;">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:16px;">7-Day History</h3>
      <canvas id="waterChart" height="200"></canvas>
      <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div style="text-align:center;padding:10px;background:var(--bg-input);border-radius:8px;"><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">7-Day Avg</div><div style="font-size:20px;font-weight:700;color:var(--accent-cyan);" id="waterWeekAvg">â€”</div></div>
        <div style="text-align:center;padding:10px;background:var(--bg-input);border-radius:8px;"><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Goal Hit Streak</div><div style="font-size:20px;font-weight:700;color:var(--accent-green);" id="waterStreak">0</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== GOALS TAB ==================== -->
<div class="tab-content" id="tab-goals">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <h1 style="font-size:22px;font-weight:700;">Goals</h1>
    <button class="btn btn-primary" onclick="openGoalModal()">+ New Goal</button>
  </div>
  <div id="goalsList" style="display:grid;gap:14px;"></div>
</div>

<!-- ==================== JOURNAL TAB ==================== -->
<div class="tab-content" id="tab-journal">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <h1 style="font-size:22px;font-weight:700;">Health Journal</h1>
    <button class="btn btn-primary" onclick="openJournalModal()">+ New Entry</button>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:16px;" id="journalFilters">
    <button class="btn btn-sm btn-primary" onclick="filterJournal('all', this)">All</button>
    <button class="btn btn-sm btn-secondary" onclick="filterJournal('mood', this)">ğŸ˜Š Mood</button>
    <button class="btn btn-sm btn-secondary" onclick="filterJournal('energy', this)">âš¡ Energy</button>
    <button class="btn btn-sm btn-secondary" onclick="filterJournal('symptoms', this)">ğŸ©º Symptoms</button>
    <button class="btn btn-sm btn-secondary" onclick="filterJournal('general', this)">ğŸ“ General</button>
    <button class="btn btn-sm btn-secondary" onclick="filterJournal('starred', this)">â­ Starred</button>
  </div>
  <div id="journalList" style="display:grid;gap:12px;"></div>
</div>

<!-- ==================== REPORTS TAB ==================== -->
<div class="tab-content" id="tab-reports">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <h1 style="font-size:22px;font-weight:700;">Reports & Analytics</h1>
    <div style="display:flex;gap:8px;">
      <select id="reportRange" onchange="renderReports()" style="width:auto;">
        <option value="7">Last 7 Days</option>
        <option value="14">Last 14 Days</option>
        <option value="30" selected>Last 30 Days</option>
        <option value="90">Last 90 Days</option>
        <option value="all">All Time</option>
      </select>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
    <div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Weight Over Time</h3><canvas id="reportWeightChart" height="200"></canvas></div>
    <div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Body Fat % Over Time</h3><canvas id="reportBodyFatChart" height="200"></canvas></div>
    <div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Glucose & GKI</h3><canvas id="reportGlucoseChart" height="200"></canvas></div>
    <div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Steps & Activity</h3><canvas id="reportExerciseChart" height="200"></canvas></div>
  </div>
  <div class="card">
    <h3 style="font-size:14px;font-weight:600;margin-bottom:14px;">Weekly Averages</h3>
    <div id="weeklyAverages"></div>
  </div>
</div>

<!-- ==================== SETTINGS TAB ==================== -->
<div class="tab-content" id="tab-settings">
  <h1 style="font-size:22px;font-weight:700;margin-bottom:20px;">Settings</h1>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
    <div class="card">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:16px;">Profile & Units</h3>
      <div style="display:grid;gap:12px;">
        <div><label>Weight Unit</label><select id="setWeightUnit"><option value="lbs">Pounds (lbs)</option><option value="kg">Kilograms (kg)</option></select></div>
        <div><label>Measurement Unit</label><select id="setMeasureUnit"><option value="in">Inches (in)</option><option value="cm">Centimeters (cm)</option></select></div>
        <div><label>Height (inches)</label><input type="number" id="setHeight" value="70"></div>
        <div><label>Starting Weight (lbs)</label><input type="number" id="setStartWeight" value="209.8" step="0.1"></div>
        <div><label>Goal Weight (lbs)</label><input type="number" id="setGoalWeight" value="170" step="0.1"></div>
        <div><label>Lbs to Lose (auto-calc)</label><input type="number" id="setWeightGoal" value="39.8" step="0.1" readonly style="color:var(--text-secondary);"></div>
        <button class="btn btn-primary" onclick="saveSettings()" style="margin-top:8px;">Save Settings</button>
      </div>
    </div>
    <div class="card">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:16px;">Data Management</h3>
      <div style="display:grid;gap:10px;">
        <button class="btn btn-primary" onclick="exportJSON()">ğŸ“¦ Export All Data (JSON)</button>
        <button class="btn btn-success" onclick="exportExcel()">ğŸ“Š Export to Excel</button>
        <button class="btn btn-secondary" onclick="generatePDFReport()">ğŸ“„ PDF Summary Report</button>
        <div style="position:relative;">
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¥ Import Data (JSON)</button>
          <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importJSON(event)">
        </div>
        <div style="position:relative;">
          <button class="btn btn-secondary" onclick="document.getElementById('importXlsxFile').click()">ğŸ“¥ Import from Excel (.xlsx)</button>
          <input type="file" id="importXlsxFile" accept=".xlsx,.xls" style="display:none;" onchange="importExcel(event)">
        </div>
        <hr style="border-color:var(--border-subtle);margin:8px 0;">
        <button class="btn btn-danger" onclick="confirmClearData()">ğŸ—‘ Clear All Data</button>
      </div>
    </div>
  </div>
  <div class="card" style="margin-top:16px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3 style="font-size:14px;font-weight:600;">ğŸ¯ Healthy Habits</h3>
    </div>
    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">Add daily habits to track on your dashboard. Check them off each day to build streaks.</p>

    <!-- Add new habit form -->
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <input type="text" id="newHabitEmoji" placeholder="ğŸ¥—" style="width:52px;text-align:center;font-size:18px;" maxlength="2">
      <input type="text" id="newHabitName" placeholder="Habit name (e.g. No Processed Food)" style="flex:1;">
      <button class="btn btn-primary btn-sm" onclick="addHabit()">+ Add</button>
    </div>

    <!-- Habits list -->
    <div id="settingsHabitsList" style="display:grid;gap:8px;"></div>

    <!-- Quick-add presets -->
    <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border-subtle);">
      <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px;">Quick Add Presets</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;" id="habitPresets">
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸš«','No Processed Food')">ğŸš« No Processed Food</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ’§','H2O Only')">ğŸ’§ H2O Only</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸš¶','Walking')">ğŸš¶ Walking</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ§˜','Stretching')">ğŸ§˜ Stretching</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ’Š','Vitamins')">ğŸ’Š Vitamins</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ›ï¸','8hrs Sleep')">ğŸ›ï¸ 8hrs Sleep</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ™','Daily Rosary')">ğŸ™ Daily Rosary</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ“–','Bible Reading')">ğŸ“– Bible Reading</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ¬','No Sugar')">ğŸ¬ No Sugar</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ¥¬','Ate Vegetables')">ğŸ¥¬ Ate Vegetables</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ‹ï¸','Exercise')">ğŸ‹ï¸ Exercise</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAddHabit('ğŸ“','Journaling')">ğŸ“ Journaling</button>
      </div>
    </div>
  </div>
  <div class="card" style="margin-top:16px;">
    <h3 style="font-size:14px;font-weight:600;margin-bottom:12px;">Keyboard Shortcuts</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:12px;">
      <div><span class="mono" style="color:var(--accent-blue);">N W</span> â€” New Weight Entry</div>
      <div><span class="mono" style="color:var(--accent-blue);">N G</span> â€” New Glucose Reading</div>
      <div><span class="mono" style="color:var(--accent-blue);">N E</span> â€” New Exercise Entry</div>
      <div><span class="mono" style="color:var(--accent-blue);">N F</span> â€” New Fasting Log</div>
      <div><span class="mono" style="color:var(--accent-blue);">N J</span> â€” New Journal Entry</div>
      <div><span class="mono" style="color:var(--accent-blue);">Ctrl+K</span> â€” Global Search</div>
    </div>
  </div>
</div>

<!-- ==================== MODALS ==================== -->
<!-- Weight Modal -->
<div class="modal-overlay" id="weightModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('weightModal')">âœ•</button>
    <h2 style="font-size:18px;font-weight:700;margin-bottom:20px;" id="weightModalTitle">New Weight Entry</h2>
    <input type="hidden" id="weightEditId">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div><label>Date</label><input type="date" id="wDate"></div>
      <div><label>Weight (lbs)</label><input type="number" id="wWeight" step="0.1"></div>
      <div><label>BMI</label><input type="number" id="wBMI" step="0.1"></div>
      <div><label>Body Fat %</label><input type="number" id="wBodyFat" step="0.1"></div>
      <div><label>Fat-free Weight</label><input type="number" id="wFatFree" step="0.1"></div>
      <div><label>Subcutaneous Fat %</label><input type="number" id="wSubFat" step="0.1"></div>
      <div><label>Visceral Fat</label><input type="number" id="wVisceral" step="0.1"></div>
      <div><label>Body Water %</label><input type="number" id="wWater" step="0.1"></div>
      <div><label>Skeletal Muscle %</label><input type="number" id="wSkeletal" step="0.1"></div>
      <div><label>Muscle Mass</label><input type="number" id="wMuscleMass" step="0.1"></div>
      <div><label>Bone Mass</label><input type="number" id="wBone" step="0.1"></div>
      <div><label>Protein %</label><input type="number" id="wProtein" step="0.1"></div>
      <div><label>BMR</label><input type="number" id="wBMR" step="1"></div>
      <div><label>Metabolic Age</label><input type="number" id="wMetAge" step="1"></div>
    </div>
    <div style="margin-top:12px;"><label>Comments</label><textarea id="wComments" rows="2"></textarea></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('weightModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveWeight()">Save Entry</button>
    </div>
  </div>
</div>

<!-- Glucose Modal -->
<div class="modal-overlay" id="glucoseModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('glucoseModal')">âœ•</button>
    <h2 style="font-size:18px;font-weight:700;margin-bottom:20px;" id="glucoseModalTitle">New Glucose Reading</h2>
    <input type="hidden" id="glucoseEditId">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div><label>Date</label><input type="date" id="gDate"></div>
      <div><label>Time</label><input type="time" id="gTime"></div>
      <div><label>Glucose (mg/dL)</label><input type="number" id="gGlucose" step="1"></div>
      <div><label>Ketones (mmol/L)</label><input type="number" id="gKetones" step="0.1"></div>
    </div>
    <div style="margin-top:12px;">
      <label>GKI (auto-calculated)</label>
      <input type="text" id="gGKI" readonly style="color:var(--accent-amber);">
    </div>
    <div style="margin-top:12px;"><label>Comments</label><textarea id="gComments" rows="2"></textarea></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('glucoseModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGlucose()">Save Reading</button>
    </div>
  </div>
</div>

<!-- Exercise Modal -->
<div class="modal-overlay" id="exerciseModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('exerciseModal')">âœ•</button>
    <h2 style="font-size:18px;font-weight:700;margin-bottom:20px;" id="exerciseModalTitle">New Exercise Entry</h2>
    <input type="hidden" id="exerciseEditId">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div><label>Date</label><input type="date" id="eDate"></div>
      <div><label>Steps</label><input type="number" id="eSteps" step="1"></div>
      <div><label>Miles</label><input type="number" id="eMiles" step="0.001"></div>
      <div><label>Avg Heart Rate</label><input type="number" id="eAvgHR" step="1"></div>
      <div><label>Resting Heart Rate</label><input type="number" id="eRestHR" step="1"></div>
      <div><label>VO2 Max</label><input type="number" id="eVO2" step="0.1"></div>
    </div>
    <div style="margin-top:12px;"><label>Notes</label><textarea id="eNotes" rows="2"></textarea></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('exerciseModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExercise()">Save Entry</button>
    </div>
  </div>
</div>

<!-- Fasting Modal -->
<div class="modal-overlay" id="fastingModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('fastingModal')">âœ•</button>
    <h2 style="font-size:18px;font-weight:700;margin-bottom:20px;">Log Fasting Day</h2>
    <input type="hidden" id="fastingEditId">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div><label>Date</label><input type="date" id="fDate"></div>
      <div>
        <label>Status</label>
        <select id="fStatus">
          <option value="OMAD">OMAD</option>
          <option value="Fasting">Fasting</option>
          <option value="Free Day">Free Day</option>
        </select>
      </div>
      <div><label>Fast Duration (hours)</label><input type="number" id="fDuration" step="0.5" value="16"></div>
      <div>
        <label>Completed?</label>
        <select id="fCompleted">
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>
    <div style="margin-top:12px;"><label>Notes</label><textarea id="fNotes" rows="2"></textarea></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('fastingModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveFasting()">Save</button>
    </div>
  </div>
</div>

<!-- Goal Modal -->
<div class="modal-overlay" id="goalModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('goalModal')">âœ•</button>
    <h2 style="font-size:18px;font-weight:700;margin-bottom:20px;">Set Goal</h2>
    <input type="hidden" id="goalEditId">
    <div style="display:grid;gap:12px;">
      <div><label>Goal Name</label><input type="text" id="goName" placeholder="e.g., Reach 186 lbs"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div><label>Category</label>
          <select id="goCategory">
            <option value="weight">Weight</option>
            <option value="body_fat">Body Fat %</option>
            <option value="exercise">Exercise</option>
            <option value="fasting">Fasting</option>
            <option value="glucose">Glucose</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div><label>Target Value</label><input type="number" id="goTarget" step="0.1"></div>
        <div><label>Current Value</label><input type="number" id="goCurrent" step="0.1"></div>
        <div><label>Start Value</label><input type="number" id="goStart" step="0.1"></div>
      </div>
      <div><label>Target Date</label><input type="date" id="goDate"></div>
      <div><label>Notes</label><textarea id="goNotes" rows="2"></textarea></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('goalModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGoal()">Save Goal</button>
    </div>
  </div>
</div>

<!-- Journal Modal -->
<div class="modal-overlay" id="journalModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('journalModal')">âœ•</button>
    <h2 style="font-size:18px;font-weight:700;margin-bottom:20px;" id="journalModalTitle">New Journal Entry</h2>
    <input type="hidden" id="journalEditId">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div><label>Date</label><input type="date" id="jDate"></div>
      <div><label>Category</label>
        <select id="jCategory">
          <option value="general">ğŸ“ General</option>
          <option value="mood">ğŸ˜Š Mood</option>
          <option value="energy">âš¡ Energy</option>
          <option value="symptoms">ğŸ©º Symptoms</option>
        </select>
      </div>
    </div>
    <div style="margin-top:12px;"><label>Entry</label><textarea id="jEntry" rows="6" placeholder="How are you feeling today?"></textarea></div>
    <div style="margin-top:12px;display:flex;gap:12px;">
      <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
        <input type="checkbox" id="jStarred"> â­ Star this entry
      </label>
      <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
        <input type="checkbox" id="jPinned"> ğŸ“Œ Pin to top
      </label>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('journalModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveJournal()">Save Entry</button>
    </div>
  </div>
</div>

<!-- Weight Goals Modal -->
<div class="modal-overlay" id="weightGoalsModal">
  <div class="modal" style="max-width:440px;">
    <button class="modal-close" onclick="closeModal('weightGoalsModal')">âœ•</button>
    <h2 style="font-size:18px;font-weight:700;margin-bottom:6px;">âš–ï¸ Weight Goals</h2>
    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:20px;">Edit any field â€” the others will auto-calculate.</p>
    <div style="display:grid;gap:16px;">
      <div>
        <label>Starting Weight (lbs)</label>
        <input type="number" id="wgStart" step="0.1" oninput="recalcWeightGoals('start')">
      </div>
      <div>
        <label>Goal Weight (lbs)</label>
        <input type="number" id="wgGoal" step="0.1" placeholder="e.g. 170" oninput="recalcWeightGoals('goal')">
      </div>
      <div>
        <label>Pounds to Lose</label>
        <input type="number" id="wgToLose" step="0.1" oninput="recalcWeightGoals('toLose')">
      </div>
      <div style="padding:14px;background:var(--bg-input);border-radius:10px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div style="font-size:11px;color:var(--text-muted);">Current Weight</div>
        <div style="font-size:14px;font-weight:600;text-align:right;" id="wgCurrentDisp">â€”</div>
        <div style="font-size:11px;color:var(--text-muted);">Already Lost</div>
        <div style="font-size:14px;font-weight:600;text-align:right;color:var(--accent-green);" id="wgAlreadyLost">â€”</div>
        <div style="font-size:11px;color:var(--text-muted);">Still Remaining</div>
        <div style="font-size:14px;font-weight:600;text-align:right;color:var(--accent-amber);" id="wgRemaining">â€”</div>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal('weightGoalsModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveWeightGoals()">Save Goals</button>
    </div>
  </div>
</div>

<!-- Search Results Modal -->
<div class="modal-overlay" id="searchModal">
  <div class="modal" style="max-width:700px;">
    <button class="modal-close" onclick="closeModal('searchModal')">âœ•</button>
    <h2 style="font-size:18px;font-weight:700;margin-bottom:16px;">ğŸ” Search Results</h2>
    <div id="searchResults" style="display:grid;gap:8px;max-height:60vh;overflow-y:auto;"></div>
  </div>
</div>

<script>
// ============================================================
// DATA STORE
// ============================================================
const DB_KEY = 'vitaltrack_data';
let APP = loadData();
let charts = {};
let fastTimer = null;
let fastTimerRunning = false;
let habitViewDate = new Date().toISOString().split('T')[0]; // for date nav

function defaultData() {
  return {
    settings: {
      weightUnit: 'lbs', measureUnit: 'in', height: 70,
      weightGoal: 39.8, goalWeight: 170, startWeight: 209.8
    },
    weight: [],
    glucose: [],
    exercise: [],
    fasting: [],
    goals: [],
    journal: [],
    habits: [],
    habitLog: {},
    waterLog: {},
    waterGoal: 128,
    fastTimerState: null
  };
}

function loadData() {
  try {
    const d = JSON.parse(localStorage.getItem(DB_KEY));
    if (d && d.weight) {
      // Migrate: add goalWeight if missing
      if (!d.settings.goalWeight) {
        d.settings.goalWeight = d.settings.startWeight - (d.settings.weightGoal || 23.2);
      }
      // Migrate: add habits if missing
      if (!d.habits) d.habits = [];
      if (!d.habitLog) d.habitLog = {};
      if (!d.waterLog) d.waterLog = {};
      if (!d.waterGoal) d.waterGoal = 128;
      return d;
    }
  } catch(e) {}
  return seedData();
}

function saveData() {
  localStorage.setItem(DB_KEY, JSON.stringify(APP));
  document.getElementById('autoSaveIndicator').innerHTML = 'â— Saved';
  document.getElementById('autoSaveIndicator').style.color = 'var(--accent-green)';
  setTimeout(() => {
    document.getElementById('autoSaveIndicator').style.color = 'var(--text-muted)';
  }, 2000);
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }

// ============================================================
// SEED DATA FROM SPREADSHEET
// ============================================================
function seedData() {
  const d = defaultData();

  // Weight entries from Weight Loss sheet
  d.weight = [
    { id: uid(), date: '2025-11-11', weight: 209.8, bmi: 30, bodyFat: 28.1, fatFreeWeight: 150.8, subFat: 24.3, visceral: 13, water: 51.9, skeletal: 46.4, muscleMass: 143.2, bone: 7.6, protein: 16.4, bmr: 1847, metAge: 57, comments: '' },
    { id: uid(), date: '2025-11-12', weight: 207.2, bmi: 29.7, bodyFat: 27.6, fatFreeWeight: 150, subFat: 23.9, visceral: 12, water: 52.3, skeletal: 46.8, muscleMass: 142.4, bone: 7.4, protein: 16.5, bmr: 1839, metAge: 57, comments: '' },
    { id: uid(), date: '2025-11-13', weight: 203.6, bmi: 29.1, bodyFat: 26.7, fatFreeWeight: 149.2, subFat: 23.2, visceral: 11, water: 52.9, skeletal: 47.4, muscleMass: 141.8, bone: 7.4, protein: 16.7, bmr: 1832, metAge: 56, comments: '' },
    { id: uid(), date: '2025-11-14', weight: 202.8, bmi: 29, bodyFat: 26.5, fatFreeWeight: 149, subFat: 23, visceral: 11, water: 53, skeletal: 47.6, muscleMass: 141.8, bone: 7.4, protein: 16.7, bmr: 1832, metAge: 56, comments: '' },
  ];

  // Glucose entries
  d.glucose = [
    { id: uid(), date: '2025-10-15', time: '14:24', glucose: 56, ketones: 2.3, gki: 1.35, comments: 'Day 3 Fasting Results' },
    { id: uid(), date: '2025-10-16', time: '13:31', glucose: 69, ketones: 3.7, gki: 1.04, comments: 'Day 4 Fasting Results' },
    { id: uid(), date: '2025-10-17', time: '13:42', glucose: 78, ketones: 4.0, gki: 1.08, comments: 'Day 5 Fasting Results' },
    { id: uid(), date: '2025-10-18', time: '11:56', glucose: 84, ketones: 4.0, gki: 1.17, comments: 'Day 6 Fasting Results' },
    { id: uid(), date: '2025-11-12', time: '15:35', glucose: 87, ketones: 1.2, gki: 4.03, comments: 'Day 2 Fasting Results' },
  ];

  // Exercise entries
  d.exercise = [
    { id: uid(), date: '2025-10-14', steps: 22468, miles: 11.234, avgHR: 77, restHR: 57, vo2: 45.6, notes: '' },
    { id: uid(), date: '2025-10-15', steps: 26738, miles: 13.369, avgHR: 77, restHR: 57, vo2: 45.6, notes: '' },
    { id: uid(), date: '2025-10-16', steps: 23840, miles: 11.92, avgHR: 78, restHR: 55, vo2: 45.2, notes: '' },
  ];

  // Default goal from spreadsheet
  d.goals = [
    { id: uid(), name: 'Weight Loss Goal', category: 'weight', target: 170, current: 202.8, start: 209.8, targetDate: '2026-03-01', notes: 'Lose 39.8 lbs â€” Goal weight: 170 lbs' }
  ];

  d.settings.weightGoal = 39.8;
  d.settings.goalWeight = 170;
  d.settings.startWeight = 209.8;

  // Default habits
  d.habits = [
    { id: uid(), emoji: 'ğŸš«', name: 'No Processed Food' },
    { id: uid(), emoji: 'ğŸ’§', name: 'H2O Only' },
    { id: uid(), emoji: 'ğŸš¶', name: 'Walking' },
    { id: uid(), emoji: 'ğŸ™', name: 'Daily Rosary' },
    { id: uid(), emoji: 'ğŸ’Š', name: 'Vitamins' },
  ];
  d.habitLog = {};

  localStorage.setItem(DB_KEY, JSON.stringify(d));
  return d;
}

// ============================================================
// TOAST NOTIFICATIONS
// ============================================================
function toast(msg, type = 'success') {
  const c = document.getElementById('toastContainer');
  const icons = { success: 'âœ“', error: 'âœ•', info: 'â„¹' };
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.innerHTML = `<span>${icons[type] || ''}</span> ${msg}`;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(100px)'; setTimeout(() => t.remove(), 300); }, 3000);
}

// ============================================================
// TAB NAVIGATION
// ============================================================
function switchTab(tabId) {
  document.querySelectorAll('.tab-btn, .mobile-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll(`[data-tab="${tabId}"]`).forEach(b => b.classList.add('active'));
  document.getElementById(`tab-${tabId}`).classList.add('active');
  refreshCurrentTab(tabId);
}

document.querySelectorAll('.tab-btn, .mobile-tab').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

function refreshCurrentTab(tab) {
  switch(tab) {
    case 'dashboard': renderDashboard(); break;
    case 'weight': renderWeight(); break;
    case 'glucose': renderGlucose(); break;
    case 'exercise': renderExercise(); break;
    case 'fasting': renderFasting(); break;
    case 'water': renderWater(); break;
    case 'goals': renderGoals(); break;
    case 'journal': renderJournal(); break;
    case 'reports': renderReports(); break;
    case 'settings': renderSettings(); break;
  }
}

// ============================================================
// MODAL HELPERS
// ============================================================
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', (e) => { if (e.target === o) o.classList.remove('active'); });
});

// ============================================================
// WEIGHT FUNCTIONS
// ============================================================
function openWeightModal(editId) {
  const m = 'weightModal';
  document.getElementById('weightEditId').value = '';
  document.getElementById('weightModalTitle').textContent = 'New Weight Entry';
  document.getElementById('wDate').value = new Date().toISOString().split('T')[0];
  ['wWeight','wBMI','wBodyFat','wFatFree','wSubFat','wVisceral','wWater','wSkeletal','wMuscleMass','wBone','wProtein','wBMR','wMetAge'].forEach(f => document.getElementById(f).value = '');
  document.getElementById('wComments').value = '';

  if (editId) {
    const entry = APP.weight.find(w => w.id === editId);
    if (entry) {
      document.getElementById('weightEditId').value = editId;
      document.getElementById('weightModalTitle').textContent = 'Edit Weight Entry';
      document.getElementById('wDate').value = entry.date;
      document.getElementById('wWeight').value = entry.weight || '';
      document.getElementById('wBMI').value = entry.bmi || '';
      document.getElementById('wBodyFat').value = entry.bodyFat || '';
      document.getElementById('wFatFree').value = entry.fatFreeWeight || '';
      document.getElementById('wSubFat').value = entry.subFat || '';
      document.getElementById('wVisceral').value = entry.visceral || '';
      document.getElementById('wWater').value = entry.water || '';
      document.getElementById('wSkeletal').value = entry.skeletal || '';
      document.getElementById('wMuscleMass').value = entry.muscleMass || '';
      document.getElementById('wBone').value = entry.bone || '';
      document.getElementById('wProtein').value = entry.protein || '';
      document.getElementById('wBMR').value = entry.bmr || '';
      document.getElementById('wMetAge').value = entry.metAge || '';
      document.getElementById('wComments').value = entry.comments || '';
    }
  }
  openModal(m);
}

function saveWeight() {
  const editId = document.getElementById('weightEditId').value;
  const entry = {
    id: editId || uid(),
    date: document.getElementById('wDate').value,
    weight: parseFloat(document.getElementById('wWeight').value) || 0,
    bmi: parseFloat(document.getElementById('wBMI').value) || 0,
    bodyFat: parseFloat(document.getElementById('wBodyFat').value) || 0,
    fatFreeWeight: parseFloat(document.getElementById('wFatFree').value) || 0,
    subFat: parseFloat(document.getElementById('wSubFat').value) || 0,
    visceral: parseFloat(document.getElementById('wVisceral').value) || 0,
    water: parseFloat(document.getElementById('wWater').value) || 0,
    skeletal: parseFloat(document.getElementById('wSkeletal').value) || 0,
    muscleMass: parseFloat(document.getElementById('wMuscleMass').value) || 0,
    bone: parseFloat(document.getElementById('wBone').value) || 0,
    protein: parseFloat(document.getElementById('wProtein').value) || 0,
    bmr: parseFloat(document.getElementById('wBMR').value) || 0,
    metAge: parseFloat(document.getElementById('wMetAge').value) || 0,
    comments: document.getElementById('wComments').value
  };

  if (!entry.date || !entry.weight) { toast('Date and weight are required', 'error'); return; }

  if (editId) {
    const idx = APP.weight.findIndex(w => w.id === editId);
    if (idx >= 0) APP.weight[idx] = entry;
  } else {
    APP.weight.push(entry);
  }
  APP.weight.sort((a, b) => a.date.localeCompare(b.date));
  saveData();
  closeModal('weightModal');
  toast(editId ? 'Weight entry updated' : 'Weight entry saved');
  renderWeight();
  updateBadges();
}

// Weight Goals Modal
function openWeightGoalsModal() {
  const startW = APP.settings.startWeight || 209.8;
  const goalW = APP.settings.goalWeight || 170;
  const toLose = startW - goalW;
  document.getElementById('wgStart').value = startW;
  document.getElementById('wgGoal').value = goalW;
  document.getElementById('wgToLose').value = parseFloat(toLose.toFixed(1));

  // Show current stats
  const wSorted = [...APP.weight].sort((a, b) => b.date.localeCompare(a.date));
  const current = wSorted.length > 0 ? wSorted[0].weight : startW;
  document.getElementById('wgCurrentDisp').textContent = current + ' lbs';
  document.getElementById('wgAlreadyLost').textContent = (startW - current).toFixed(1) + ' lbs';
  document.getElementById('wgRemaining').textContent = (current - goalW).toFixed(1) + ' lbs';

  openModal('weightGoalsModal');
}

function recalcWeightGoals(changed) {
  const startVal = parseFloat(document.getElementById('wgStart').value) || 0;
  const goalVal = parseFloat(document.getElementById('wgGoal').value) || 0;
  const toLoseVal = parseFloat(document.getElementById('wgToLose').value) || 0;

  if (changed === 'start') {
    // Recalc lbs to lose from start - goal
    if (goalVal > 0) document.getElementById('wgToLose').value = parseFloat((startVal - goalVal).toFixed(1));
  } else if (changed === 'goal') {
    // Recalc lbs to lose from start - goal
    if (startVal > 0) document.getElementById('wgToLose').value = parseFloat((startVal - goalVal).toFixed(1));
  } else if (changed === 'toLose') {
    // Recalc goal weight from start - toLose
    if (startVal > 0) document.getElementById('wgGoal').value = parseFloat((startVal - toLoseVal).toFixed(1));
  }

  // Update the preview stats
  const newStart = parseFloat(document.getElementById('wgStart').value) || 0;
  const newGoal = parseFloat(document.getElementById('wgGoal').value) || 0;
  const wSorted = [...APP.weight].sort((a, b) => b.date.localeCompare(a.date));
  const current = wSorted.length > 0 ? wSorted[0].weight : newStart;
  document.getElementById('wgCurrentDisp').textContent = current + ' lbs';
  document.getElementById('wgAlreadyLost').textContent = (newStart - current).toFixed(1) + ' lbs';
  document.getElementById('wgRemaining').textContent = (current - newGoal).toFixed(1) + ' lbs';
}

function saveWeightGoals() {
  const startW = parseFloat(document.getElementById('wgStart').value);
  const goalW = parseFloat(document.getElementById('wgGoal').value);
  const toLose = parseFloat(document.getElementById('wgToLose').value);
  if (!startW || !goalW) { toast('Starting weight and goal weight are required', 'error'); return; }
  APP.settings.startWeight = startW;
  APP.settings.goalWeight = goalW;
  APP.settings.weightGoal = toLose || (startW - goalW);
  saveData();
  closeModal('weightGoalsModal');
  toast('Weight goals updated');
  renderWeight();
  renderDashboard();
}

function deleteWeight(id) {
  if (!confirm('Delete this weight entry?')) return;
  APP.weight = APP.weight.filter(w => w.id !== id);
  saveData(); renderWeight(); updateBadges();
  toast('Entry deleted', 'info');
}

function renderWeight() {
  const sorted = [...APP.weight].sort((a, b) => b.date.localeCompare(a.date));
  const tbody = document.getElementById('weightTableBody');
  tbody.innerHTML = sorted.map((w, i) => {
    const prev = sorted[i + 1];
    const change = prev ? (prev.weight - w.weight).toFixed(1) : 'â€”';
    const changeClass = change !== 'â€”' ? (parseFloat(change) > 0 ? 'color:var(--accent-green)' : parseFloat(change) < 0 ? 'color:var(--accent-red)' : '') : '';
    return `<tr onclick="openWeightModal('${w.id}')">
      <td class="mono" style="font-size:12px;">${formatDate(w.date)}</td>
      <td style="font-weight:600;">${w.weight}</td>
      <td style="${changeClass};font-weight:600;">${change !== 'â€”' ? (parseFloat(change) > 0 ? '+' : '') + change : 'â€”'}</td>
      <td>${w.bmi || 'â€”'}</td><td>${w.bodyFat || 'â€”'}%</td>
      <td>${w.subFat || 'â€”'}%</td><td>${w.visceral || 'â€”'}</td><td>${w.water || 'â€”'}%</td>
      <td>${w.skeletal || 'â€”'}%</td><td>${w.muscleMass || 'â€”'}</td><td>${w.bone || 'â€”'}</td>
      <td>${w.protein || 'â€”'}%</td><td>${w.bmr || 'â€”'}</td><td>${w.metAge || 'â€”'}</td>
      <td style="font-size:12px;color:var(--text-secondary);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${w.comments || ''}</td>
      <td><button class="btn btn-sm" style="color:var(--accent-red);background:none;padding:4px 8px;" onclick="event.stopPropagation();deleteWeight('${w.id}')">ğŸ—‘</button></td>
    </tr>`;
  }).join('');

  // Summary cards
  if (sorted.length > 0) {
    const latest = sorted[0];
    const startW = APP.settings.startWeight || sorted[sorted.length - 1].weight;
    const goalW = APP.settings.goalWeight || 170;
    const lbsToLose = APP.settings.weightGoal || (startW - goalW);
    const totalLost = startW - latest.weight;
    const remaining = latest.weight - goalW;
    const first = sorted[sorted.length - 1];
    const days = Math.max(1, Math.ceil((new Date(latest.date) - new Date(first.date)) / 86400000));
    document.getElementById('weightStarting').textContent = startW;
    document.getElementById('weightCurrent').textContent = latest.weight;
    document.getElementById('weightLost').textContent = totalLost.toFixed(1);
    document.getElementById('weightGoalDisp').textContent = goalW;
    document.getElementById('weightToLose').textContent = lbsToLose.toFixed(1);
    document.getElementById('weightRemaining').textContent = remaining.toFixed(1);
    document.getElementById('weightAvgLoss').textContent = (totalLost / days).toFixed(2);
  }

  renderWeightChart();
}

function renderWeightChart() {
  const sorted = [...APP.weight].sort((a, b) => a.date.localeCompare(b.date)).filter(w => w.weight > 0);
  if (charts.weightTrend) charts.weightTrend.destroy();
  const ctx = document.getElementById('weightTrendChart');
  if (!ctx || sorted.length === 0) return;
  charts.weightTrend = new Chart(ctx, {
    type: 'line',
    data: {
      labels: sorted.map(w => formatDateShort(w.date)),
      datasets: [{
        label: 'Weight', data: sorted.map(w => w.weight),
        borderColor: '#4a7cff', backgroundColor: 'rgba(74,124,255,0.1)',
        fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#4a7cff'
      }, {
        label: 'Body Fat %', data: sorted.map(w => w.bodyFat),
        borderColor: '#f87171', backgroundColor: 'transparent',
        tension: 0.3, pointRadius: 3, yAxisID: 'y2'
      }]
    },
    options: chartOpts('Weight (lbs)', 'Body Fat %')
  });
}

// ============================================================
// GLUCOSE FUNCTIONS
// ============================================================
function openGlucoseModal(editId) {
  document.getElementById('glucoseEditId').value = '';
  document.getElementById('glucoseModalTitle').textContent = 'New Glucose Reading';
  document.getElementById('gDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('gTime').value = new Date().toTimeString().slice(0, 5);
  ['gGlucose', 'gKetones'].forEach(f => document.getElementById(f).value = '');
  document.getElementById('gGKI').value = '';
  document.getElementById('gComments').value = '';

  if (editId) {
    const entry = APP.glucose.find(g => g.id === editId);
    if (entry) {
      document.getElementById('glucoseEditId').value = editId;
      document.getElementById('glucoseModalTitle').textContent = 'Edit Glucose Reading';
      document.getElementById('gDate').value = entry.date;
      document.getElementById('gTime').value = entry.time;
      document.getElementById('gGlucose').value = entry.glucose;
      document.getElementById('gKetones').value = entry.ketones;
      document.getElementById('gGKI').value = entry.gki;
      document.getElementById('gComments').value = entry.comments;
    }
  }
  openModal('glucoseModal');
}

// Auto-calculate GKI
document.getElementById('gGlucose').addEventListener('input', calcGKI);
document.getElementById('gKetones').addEventListener('input', calcGKI);
function calcGKI() {
  const g = parseFloat(document.getElementById('gGlucose').value);
  const k = parseFloat(document.getElementById('gKetones').value);
  if (g > 0 && k > 0) {
    const gki = (g / 18) / k;
    document.getElementById('gGKI').value = gki.toFixed(2);
  }
}

function getGKICategory(gki) {
  if (gki < 1) return { label: 'Highest Therapeutic', cls: 'gki-highest' };
  if (gki <= 3) return { label: 'Therapeutic', cls: 'gki-therapeutic' };
  if (gki <= 6) return { label: 'Moderate', cls: 'gki-moderate' };
  if (gki <= 9) return { label: 'Mild', cls: 'gki-mild' };
  return { label: 'Not in Ketosis', cls: 'gki-none' };
}

function saveGlucose() {
  const editId = document.getElementById('glucoseEditId').value;
  const g = parseFloat(document.getElementById('gGlucose').value);
  const k = parseFloat(document.getElementById('gKetones').value);
  const entry = {
    id: editId || uid(),
    date: document.getElementById('gDate').value,
    time: document.getElementById('gTime').value,
    glucose: g || 0,
    ketones: k || 0,
    gki: (g > 0 && k > 0) ? parseFloat(((g / 18) / k).toFixed(2)) : 0,
    comments: document.getElementById('gComments').value
  };
  if (!entry.date) { toast('Date is required', 'error'); return; }

  if (editId) {
    const idx = APP.glucose.findIndex(x => x.id === editId);
    if (idx >= 0) APP.glucose[idx] = entry;
  } else {
    APP.glucose.push(entry);
  }
  APP.glucose.sort((a, b) => a.date.localeCompare(b.date));
  saveData(); closeModal('glucoseModal');
  toast(editId ? 'Reading updated' : 'Glucose reading saved');
  renderGlucose(); updateBadges();
}

function deleteGlucose(id) {
  if (!confirm('Delete this glucose reading?')) return;
  APP.glucose = APP.glucose.filter(g => g.id !== id);
  saveData(); renderGlucose(); updateBadges();
  toast('Reading deleted', 'info');
}

function renderGlucose() {
  const sorted = [...APP.glucose].sort((a, b) => b.date.localeCompare(a.date) || (b.time || '').localeCompare(a.time || ''));
  const tbody = document.getElementById('glucoseTableBody');
  tbody.innerHTML = sorted.map(g => {
    const cat = getGKICategory(g.gki);
    return `<tr onclick="openGlucoseModal('${g.id}')">
      <td class="mono" style="font-size:12px;">${formatDate(g.date)}</td>
      <td class="mono" style="font-size:12px;">${g.time || 'â€”'}</td>
      <td style="font-weight:600;">${g.glucose}</td>
      <td style="font-weight:600;">${g.ketones}</td>
      <td style="font-weight:600;">${g.gki}</td>
      <td><span class="gki-badge ${cat.cls}">${cat.label}</span></td>
      <td style="font-size:12px;color:var(--text-secondary);">${g.comments || ''}</td>
      <td><button class="btn btn-sm" style="color:var(--accent-red);background:none;padding:4px 8px;" onclick="event.stopPropagation();deleteGlucose('${g.id}')">ğŸ—‘</button></td>
    </tr>`;
  }).join('');

  renderGlucoseChart();
}

function renderGlucoseChart() {
  const sorted = [...APP.glucose].sort((a, b) => a.date.localeCompare(b.date));
  if (charts.glucose) charts.glucose.destroy();
  const ctx = document.getElementById('glucoseChart');
  if (!ctx || sorted.length === 0) return;
  charts.glucose = new Chart(ctx, {
    type: 'line',
    data: {
      labels: sorted.map(g => formatDateShort(g.date)),
      datasets: [{
        label: 'Glucose', data: sorted.map(g => g.glucose),
        borderColor: '#f87171', tension: 0.3, pointRadius: 4
      }, {
        label: 'Ketones', data: sorted.map(g => g.ketones),
        borderColor: '#a78bfa', tension: 0.3, pointRadius: 4, yAxisID: 'y2'
      }, {
        label: 'GKI', data: sorted.map(g => g.gki),
        borderColor: '#fbbf24', tension: 0.3, pointRadius: 4, borderDash: [5, 5], yAxisID: 'y2'
      }]
    },
    options: chartOpts('Glucose (mg/dL)', 'Ketones / GKI')
  });
}

// ============================================================
// EXERCISE FUNCTIONS
// ============================================================
function openExerciseModal(editId) {
  document.getElementById('exerciseEditId').value = '';
  document.getElementById('exerciseModalTitle').textContent = 'New Exercise Entry';
  document.getElementById('eDate').value = new Date().toISOString().split('T')[0];
  ['eSteps','eMiles','eAvgHR','eRestHR','eVO2'].forEach(f => document.getElementById(f).value = '');
  document.getElementById('eNotes').value = '';

  if (editId) {
    const entry = APP.exercise.find(e => e.id === editId);
    if (entry) {
      document.getElementById('exerciseEditId').value = editId;
      document.getElementById('exerciseModalTitle').textContent = 'Edit Exercise Entry';
      document.getElementById('eDate').value = entry.date;
      document.getElementById('eSteps').value = entry.steps || '';
      document.getElementById('eMiles').value = entry.miles || '';
      document.getElementById('eAvgHR').value = entry.avgHR || '';
      document.getElementById('eRestHR').value = entry.restHR || '';
      document.getElementById('eVO2').value = entry.vo2 || '';
      document.getElementById('eNotes').value = entry.notes || '';
    }
  }
  openModal('exerciseModal');
}

function saveExercise() {
  const editId = document.getElementById('exerciseEditId').value;
  const entry = {
    id: editId || uid(),
    date: document.getElementById('eDate').value,
    steps: parseInt(document.getElementById('eSteps').value) || 0,
    miles: parseFloat(document.getElementById('eMiles').value) || 0,
    avgHR: parseInt(document.getElementById('eAvgHR').value) || 0,
    restHR: parseInt(document.getElementById('eRestHR').value) || 0,
    vo2: parseFloat(document.getElementById('eVO2').value) || 0,
    notes: document.getElementById('eNotes').value
  };
  if (!entry.date) { toast('Date is required', 'error'); return; }

  if (editId) {
    const idx = APP.exercise.findIndex(x => x.id === editId);
    if (idx >= 0) APP.exercise[idx] = entry;
  } else {
    APP.exercise.push(entry);
  }
  APP.exercise.sort((a, b) => a.date.localeCompare(b.date));
  saveData(); closeModal('exerciseModal');
  toast(editId ? 'Entry updated' : 'Exercise entry saved');
  renderExercise(); updateBadges();
}

function deleteExercise(id) {
  if (!confirm('Delete this exercise entry?')) return;
  APP.exercise = APP.exercise.filter(e => e.id !== id);
  saveData(); renderExercise(); updateBadges();
  toast('Entry deleted', 'info');
}

function renderExercise() {
  const sorted = [...APP.exercise].sort((a, b) => b.date.localeCompare(a.date));
  const withData = sorted.filter(e => e.steps > 0 || e.miles > 0);

  if (withData.length > 0) {
    const totalSteps = withData.reduce((s, e) => s + e.steps, 0);
    const totalMiles = withData.reduce((s, e) => s + e.miles, 0);
    const hrEntries = withData.filter(e => e.avgHR > 0);
    const restEntries = withData.filter(e => e.restHR > 0);
    document.getElementById('exTotalSteps').textContent = totalSteps.toLocaleString();
    document.getElementById('exTotalMiles').textContent = totalMiles.toFixed(1);
    document.getElementById('exAvgHR').textContent = hrEntries.length ? Math.round(hrEntries.reduce((s, e) => s + e.avgHR, 0) / hrEntries.length) : 'â€”';
    document.getElementById('exRestHR').textContent = restEntries.length ? restEntries[0].restHR : 'â€”';
    document.getElementById('exVO2').textContent = withData[0].vo2 || 'â€”';
  }

  const tbody = document.getElementById('exerciseTableBody');
  tbody.innerHTML = sorted.filter(e => e.steps > 0 || e.miles > 0 || e.avgHR > 0).map((e, i) => {
    const prev = sorted[i + 1];
    const dHR = prev && prev.avgHR && e.avgHR ? e.avgHR - prev.avgHR : null;
    const dRest = prev && prev.restHR && e.restHR ? e.restHR - prev.restHR : null;
    return `<tr onclick="openExerciseModal('${e.id}')">
      <td class="mono" style="font-size:12px;">${formatDate(e.date)}</td>
      <td style="font-weight:600;">${e.steps ? e.steps.toLocaleString() : 'â€”'}</td>
      <td>${e.miles || 'â€”'}</td>
      <td>${e.avgHR || 'â€”'}</td>
      <td style="${dHR > 0 ? 'color:var(--accent-red)' : dHR < 0 ? 'color:var(--accent-green)' : ''}">${dHR !== null ? (dHR > 0 ? '+' : '') + dHR : 'â€”'}</td>
      <td>${e.restHR || 'â€”'}</td>
      <td style="${dRest > 0 ? 'color:var(--accent-red)' : dRest < 0 ? 'color:var(--accent-green)' : ''}">${dRest !== null ? (dRest > 0 ? '+' : '') + dRest : 'â€”'}</td>
      <td>${e.vo2 || 'â€”'}</td>
      <td style="font-size:12px;color:var(--text-secondary);">${e.notes || ''}</td>
      <td><button class="btn btn-sm" style="color:var(--accent-red);background:none;padding:4px 8px;" onclick="event.stopPropagation();deleteExercise('${e.id}')">ğŸ—‘</button></td>
    </tr>`;
  }).join('');

  renderExerciseChart();
}

function renderExerciseChart() {
  const sorted = [...APP.exercise].sort((a, b) => a.date.localeCompare(b.date)).filter(e => e.steps > 0);
  if (charts.exercise) charts.exercise.destroy();
  const ctx = document.getElementById('exerciseChart');
  if (!ctx || sorted.length === 0) return;
  charts.exercise = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(e => formatDateShort(e.date)),
      datasets: [{
        label: 'Steps', data: sorted.map(e => e.steps),
        backgroundColor: 'rgba(74,124,255,0.6)', borderRadius: 4
      }, {
        label: 'Avg HR', data: sorted.map(e => e.avgHR),
        type: 'line', borderColor: '#f87171', tension: 0.3, pointRadius: 4, yAxisID: 'y2'
      }]
    },
    options: chartOpts('Steps', 'Heart Rate')
  });
}

// ============================================================
// FASTING FUNCTIONS
// ============================================================
function openFastingModal(editId) {
  document.getElementById('fastingEditId').value = '';
  document.getElementById('fDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('fStatus').value = 'OMAD';
  document.getElementById('fDuration').value = '16';
  document.getElementById('fCompleted').value = 'yes';
  document.getElementById('fNotes').value = '';

  if (editId) {
    const entry = APP.fasting.find(f => f.id === editId);
    if (entry) {
      document.getElementById('fastingEditId').value = editId;
      document.getElementById('fDate').value = entry.date;
      document.getElementById('fStatus').value = entry.status;
      document.getElementById('fDuration').value = entry.duration || '';
      document.getElementById('fCompleted').value = entry.completed;
      document.getElementById('fNotes').value = entry.notes || '';
    }
  }
  openModal('fastingModal');
}

function saveFasting() {
  const editId = document.getElementById('fastingEditId').value;
  const entry = {
    id: editId || uid(),
    date: document.getElementById('fDate').value,
    status: document.getElementById('fStatus').value,
    duration: parseFloat(document.getElementById('fDuration').value) || 0,
    completed: document.getElementById('fCompleted').value,
    notes: document.getElementById('fNotes').value
  };
  if (!entry.date) { toast('Date is required', 'error'); return; }

  if (editId) {
    const idx = APP.fasting.findIndex(f => f.id === editId);
    if (idx >= 0) APP.fasting[idx] = entry;
  } else {
    APP.fasting.push(entry);
  }
  APP.fasting.sort((a, b) => a.date.localeCompare(b.date));
  saveData(); closeModal('fastingModal');
  toast(editId ? 'Updated' : 'Fasting day logged');
  renderFasting(); updateBadges();
}

function deleteFasting(id) {
  if (!confirm('Delete this fasting entry?')) return;
  APP.fasting = APP.fasting.filter(f => f.id !== id);
  saveData(); renderFasting(); updateBadges();
  toast('Entry deleted', 'info');
}

function setMealStatus(status) {
  const today = new Date().toISOString().split('T')[0];
  let existing = APP.fasting.find(f => f.date === today);
  if (existing) {
    existing.status = status;
  } else {
    APP.fasting.push({ id: uid(), date: today, status, duration: status === 'Free Day' ? 0 : 16, completed: 'yes', notes: '' });
  }
  saveData(); renderFasting(); updateBadges();
  toast(`Today set to ${status}`);
}

function renderFasting() {
  const today = new Date().toISOString().split('T')[0];
  const todayEntry = APP.fasting.find(f => f.date === today);

  // Update pills
  document.querySelectorAll('.meal-pill').forEach(p => p.classList.remove('selected'));
  if (todayEntry) {
    const cls = todayEntry.status === 'OMAD' ? 'omad' : todayEntry.status === 'Fasting' ? 'fasting' : 'free';
    document.querySelector(`.meal-pill.${cls}`)?.classList.add('selected');
    document.getElementById('todayMealInfo').innerHTML = `<div style="font-size:18px;font-weight:700;color:var(--accent-blue);">${todayEntry.status}</div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">${todayEntry.duration ? todayEntry.duration + 'h fast' : 'No fast today'}</div>`;
  }

  // Streak calculation
  const sortedDates = [...APP.fasting].filter(f => f.status !== 'Free Day' && f.completed === 'yes').sort((a, b) => b.date.localeCompare(a.date));
  let streak = 0;
  const d = new Date();
  for (let i = 0; i < 365; i++) {
    const check = d.toISOString().split('T')[0];
    if (sortedDates.find(f => f.date === check)) { streak++; d.setDate(d.getDate() - 1); }
    else if (i === 0) { d.setDate(d.getDate() - 1); continue; } // Allow today to not be logged yet
    else break;
  }
  document.getElementById('fastingStreak').textContent = streak;

  // Monthly counts (existing streak panel)
  const month = today.slice(0, 7);
  const monthEntries = APP.fasting.filter(f => f.date.startsWith(month));
  document.getElementById('omadCount').textContent = monthEntries.filter(f => f.status === 'OMAD').length;
  document.getElementById('freeDayCount').textContent = monthEntries.filter(f => f.status === 'Free Day').length;

  // Running totals â€” all time
  document.getElementById('totalOmadAll').textContent = APP.fasting.filter(f => f.status === 'OMAD').length;
  document.getElementById('totalFastingAll').textContent = APP.fasting.filter(f => f.status === 'Fasting').length;
  document.getElementById('totalFreeAll').textContent = APP.fasting.filter(f => f.status === 'Free Day').length;

  // Running totals â€” this month
  document.getElementById('totalOmadMonth').textContent = monthEntries.filter(f => f.status === 'OMAD').length;
  document.getElementById('totalFastingMonth').textContent = monthEntries.filter(f => f.status === 'Fasting').length;
  document.getElementById('totalFreeMonth').textContent = monthEntries.filter(f => f.status === 'Free Day').length;

  // Running totals â€” this week (Sunâ€“Sat)
  const now = new Date();
  const weekStart = new Date(now); weekStart.setDate(now.getDate() - now.getDay());
  const weekKey = weekStart.toISOString().split('T')[0];
  const weekEntries = APP.fasting.filter(f => f.date >= weekKey);
  document.getElementById('totalOmadWeek').textContent = weekEntries.filter(f => f.status === 'OMAD').length;
  document.getElementById('totalFastingWeek').textContent = weekEntries.filter(f => f.status === 'Fasting').length;
  document.getElementById('totalFreeWeek').textContent = weekEntries.filter(f => f.status === 'Free Day').length;

  // Table
  const sorted = [...APP.fasting].sort((a, b) => b.date.localeCompare(a.date));
  document.getElementById('fastingTableBody').innerHTML = sorted.map(f => {
    const statusColor = f.status === 'OMAD' ? 'var(--accent-green)' : f.status === 'Fasting' ? 'var(--accent-blue)' : 'var(--accent-amber)';
    return `<tr onclick="openFastingModal('${f.id}')">
      <td class="mono" style="font-size:12px;">${formatDate(f.date)}</td>
      <td style="color:${statusColor};font-weight:600;">${f.status}</td>
      <td>${f.duration || 'â€”'}</td>
      <td>${f.completed === 'yes' ? '<span style="color:var(--accent-green);">âœ“ Yes</span>' : '<span style="color:var(--accent-red);">âœ• No</span>'}</td>
      <td style="font-size:12px;color:var(--text-secondary);">${f.notes || ''}</td>
      <td><button class="btn btn-sm" style="color:var(--accent-red);background:none;padding:4px 8px;" onclick="event.stopPropagation();deleteFasting('${f.id}')">ğŸ—‘</button></td>
    </tr>`;
  }).join('');

  // Dashboard fasting streak
  document.getElementById('dashFastStreak').textContent = streak;
}

// ============================================================
// FASTING TIMER
// ============================================================
function setFastPreset(hrs) { document.getElementById('fastHours').value = hrs; }

function toggleFastTimer() {
  if (fastTimerRunning) {
    stopFastTimer();
  } else {
    startFastTimer();
  }
}

function startFastTimer() {
  const hrs = parseFloat(document.getElementById('fastHours').value) || 16;
  const totalSec = hrs * 3600;
  const startTime = Date.now();
  APP.fastTimerState = { startTime, totalSec, running: true };
  saveData();
  fastTimerRunning = true;
  document.getElementById('fastStartBtn').innerHTML = 'â¸ Pause';
  document.getElementById('fastStartBtn').className = 'btn btn-danger btn-sm';
  document.getElementById('timerLabel').textContent = `${hrs}h Fast Active`;
  runTimerTick();
}

function stopFastTimer() {
  fastTimerRunning = false;
  if (APP.fastTimerState) APP.fastTimerState.running = false;
  saveData();
  document.getElementById('fastStartBtn').innerHTML = 'â–¶ Resume';
  document.getElementById('fastStartBtn').className = 'btn btn-primary btn-sm';
  document.getElementById('timerLabel').textContent = 'Paused';
}

function resetFastTimer() {
  fastTimerRunning = false;
  APP.fastTimerState = null;
  saveData();
  document.getElementById('timerTime').textContent = '00:00:00';
  document.getElementById('timerLabel').textContent = 'Not Active';
  document.getElementById('timerProgress').setAttribute('stroke-dashoffset', '729.2');
  document.getElementById('fastStartBtn').innerHTML = 'â–¶ Start';
  document.getElementById('fastStartBtn').className = 'btn btn-primary btn-sm';
}

function runTimerTick() {
  if (!fastTimerRunning || !APP.fastTimerState) return;
  const { startTime, totalSec } = APP.fastTimerState;
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  const remaining = Math.max(0, totalSec - elapsed);

  const hrs = Math.floor(remaining / 3600);
  const mins = Math.floor((remaining % 3600) / 60);
  const secs = remaining % 60;
  document.getElementById('timerTime').textContent = `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

  const circumference = 729.2;
  const progress = 1 - (remaining / totalSec);
  document.getElementById('timerProgress').setAttribute('stroke-dashoffset', circumference * (1 - progress));

  if (remaining <= 0) {
    document.getElementById('timerLabel').textContent = 'ğŸ‰ Fast Complete!';
    document.getElementById('timerTime').textContent = '00:00:00';
    fastTimerRunning = false;
    APP.fastTimerState = null;
    saveData();
    toast('Fasting period complete! ğŸ‰', 'success');
    document.getElementById('fastStartBtn').innerHTML = 'â–¶ Start';
    document.getElementById('fastStartBtn').className = 'btn btn-primary btn-sm';
    return;
  }

  requestAnimationFrame(runTimerTick);
}

// Restore timer state on load
function restoreTimer() {
  if (APP.fastTimerState && APP.fastTimerState.running) {
    fastTimerRunning = true;
    const hrs = (APP.fastTimerState.totalSec / 3600).toFixed(0);
    document.getElementById('timerLabel').textContent = `${hrs}h Fast Active`;
    document.getElementById('fastStartBtn').innerHTML = 'â¸ Pause';
    document.getElementById('fastStartBtn').className = 'btn btn-danger btn-sm';
    runTimerTick();
  }
}

// ============================================================
// GOALS
// ============================================================
function openGoalModal(editId) {
  document.getElementById('goalEditId').value = '';
  ['goName','goTarget','goCurrent','goStart','goDate','goNotes'].forEach(f => document.getElementById(f).value = '');
  document.getElementById('goCategory').value = 'weight';

  if (editId) {
    const g = APP.goals.find(x => x.id === editId);
    if (g) {
      document.getElementById('goalEditId').value = editId;
      document.getElementById('goName').value = g.name;
      document.getElementById('goCategory').value = g.category;
      document.getElementById('goTarget').value = g.target;
      document.getElementById('goCurrent').value = g.current;
      document.getElementById('goStart').value = g.start;
      document.getElementById('goDate').value = g.targetDate;
      document.getElementById('goNotes').value = g.notes || '';
    }
  }
  openModal('goalModal');
}

function saveGoal() {
  const editId = document.getElementById('goalEditId').value;
  const goal = {
    id: editId || uid(),
    name: document.getElementById('goName').value,
    category: document.getElementById('goCategory').value,
    target: parseFloat(document.getElementById('goTarget').value) || 0,
    current: parseFloat(document.getElementById('goCurrent').value) || 0,
    start: parseFloat(document.getElementById('goStart').value) || 0,
    targetDate: document.getElementById('goDate').value,
    notes: document.getElementById('goNotes').value
  };
  if (!goal.name) { toast('Goal name is required', 'error'); return; }

  if (editId) {
    const idx = APP.goals.findIndex(g => g.id === editId);
    if (idx >= 0) APP.goals[idx] = goal;
  } else {
    APP.goals.push(goal);
  }
  saveData(); closeModal('goalModal');
  toast(editId ? 'Goal updated' : 'Goal created');
  renderGoals();
}

function deleteGoal(id) {
  if (!confirm('Delete this goal?')) return;
  APP.goals = APP.goals.filter(g => g.id !== id);
  saveData(); renderGoals(); toast('Goal deleted', 'info');
}

function renderGoals() {
  // Auto-update weight goal current value
  const wGoal = APP.goals.find(g => g.category === 'weight');
  if (wGoal && APP.weight.length > 0) {
    const latest = [...APP.weight].sort((a, b) => b.date.localeCompare(a.date))[0];
    wGoal.current = latest.weight;
    saveData();
  }

  document.getElementById('goalsList').innerHTML = APP.goals.length === 0 ?
    '<div class="card" style="text-align:center;padding:40px;color:var(--text-secondary);">No goals set yet. Click "+ New Goal" to get started.</div>' :
    APP.goals.map(g => {
      const range = Math.abs(g.start - g.target);
      const progress = range > 0 ? Math.min(100, Math.max(0, (Math.abs(g.start - g.current) / range) * 100)) : 0;
      const colors = { weight: '--accent-blue', body_fat: '--accent-red', exercise: '--accent-green', fasting: '--accent-purple', glucose: '--accent-amber', other: '--accent-cyan' };
      const color = `var(${colors[g.category] || '--accent-blue'})`;
      return `<div class="card" style="border-left:3px solid ${color};">
        <div style="display:flex;justify-content:space-between;align-items:start;">
          <div>
            <h3 style="font-size:15px;font-weight:600;">${g.name}</h3>
            <div style="font-size:12px;color:var(--text-secondary);margin-top:2px;">${g.category} â€¢ Target: ${g.target} â€¢ Due: ${g.targetDate ? formatDate(g.targetDate) : 'No date'}</div>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="btn btn-sm btn-secondary" onclick="openGoalModal('${g.id}')">Edit</button>
            <button class="btn btn-sm" style="color:var(--accent-red);background:none;" onclick="deleteGoal('${g.id}')">ğŸ—‘</button>
          </div>
        </div>
        <div style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;">
            <span>Start: ${g.start}</span><span style="font-weight:600;">${progress.toFixed(0)}%</span><span>Target: ${g.target}</span>
          </div>
          <div class="progress-bar"><div class="progress-fill" style="width:${progress}%;background:${color};"></div></div>
          <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">Current: ${g.current}</div>
        </div>
        ${g.notes ? `<div style="font-size:12px;color:var(--text-secondary);margin-top:8px;font-style:italic;">${g.notes}</div>` : ''}
      </div>`;
    }).join('');
}

// ============================================================
// JOURNAL
// ============================================================
let journalFilter = 'all';

function openJournalModal(editId) {
  document.getElementById('journalEditId').value = '';
  document.getElementById('journalModalTitle').textContent = 'New Journal Entry';
  document.getElementById('jDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('jCategory').value = 'general';
  document.getElementById('jEntry').value = '';
  document.getElementById('jStarred').checked = false;
  document.getElementById('jPinned').checked = false;

  if (editId) {
    const j = APP.journal.find(x => x.id === editId);
    if (j) {
      document.getElementById('journalEditId').value = editId;
      document.getElementById('journalModalTitle').textContent = 'Edit Journal Entry';
      document.getElementById('jDate').value = j.date;
      document.getElementById('jCategory').value = j.category;
      document.getElementById('jEntry').value = j.entry;
      document.getElementById('jStarred').checked = j.starred;
      document.getElementById('jPinned').checked = j.pinned;
    }
  }
  openModal('journalModal');
}

function saveJournal() {
  const editId = document.getElementById('journalEditId').value;
  const entry = {
    id: editId || uid(),
    date: document.getElementById('jDate').value,
    category: document.getElementById('jCategory').value,
    entry: document.getElementById('jEntry').value,
    starred: document.getElementById('jStarred').checked,
    pinned: document.getElementById('jPinned').checked
  };
  if (!entry.entry) { toast('Entry text is required', 'error'); return; }

  if (editId) {
    const idx = APP.journal.findIndex(j => j.id === editId);
    if (idx >= 0) APP.journal[idx] = entry;
  } else {
    APP.journal.push(entry);
  }
  saveData(); closeModal('journalModal');
  toast(editId ? 'Entry updated' : 'Journal entry saved');
  renderJournal(); updateBadges();
}

function deleteJournal(id) {
  if (!confirm('Delete this journal entry?')) return;
  APP.journal = APP.journal.filter(j => j.id !== id);
  saveData(); renderJournal(); updateBadges(); toast('Entry deleted', 'info');
}

function toggleJournalStar(id) {
  const j = APP.journal.find(x => x.id === id);
  if (j) { j.starred = !j.starred; saveData(); renderJournal(); }
}

function filterJournal(f, btn) {
  journalFilter = f;
  document.querySelectorAll('#journalFilters .btn').forEach(b => { b.className = 'btn btn-sm btn-secondary'; });
  if (btn) btn.className = 'btn btn-sm btn-primary';
  renderJournal();
}

function renderJournal() {
  let entries = [...APP.journal];
  if (journalFilter === 'starred') entries = entries.filter(j => j.starred);
  else if (journalFilter !== 'all') entries = entries.filter(j => j.category === journalFilter);

  // Pinned first, then by date
  entries.sort((a, b) => {
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;
    return b.date.localeCompare(a.date);
  });

  const icons = { general: 'ğŸ“', mood: 'ğŸ˜Š', energy: 'âš¡', symptoms: 'ğŸ©º' };

  document.getElementById('journalList').innerHTML = entries.length === 0 ?
    '<div class="card" style="text-align:center;padding:40px;color:var(--text-secondary);">No journal entries yet.</div>' :
    entries.map(j => `
      <div class="card" style="cursor:pointer;${j.pinned ? 'border-left:3px solid var(--accent-amber);' : ''}" onclick="openJournalModal('${j.id}')">
        <div style="display:flex;justify-content:space-between;align-items:start;">
          <div style="display:flex;gap:8px;align-items:center;">
            <span style="font-size:18px;">${icons[j.category] || 'ğŸ“'}</span>
            <div>
              <div style="font-size:13px;font-weight:600;">${formatDate(j.date)} ${j.pinned ? 'ğŸ“Œ' : ''}</div>
              <div style="font-size:11px;color:var(--text-muted);text-transform:capitalize;">${j.category}</div>
            </div>
          </div>
          <div style="display:flex;gap:6px;align-items:center;">
            <button class="btn btn-sm" style="background:none;font-size:16px;padding:4px;" onclick="event.stopPropagation();toggleJournalStar('${j.id}')">${j.starred ? 'â­' : 'â˜†'}</button>
            <button class="btn btn-sm" style="color:var(--accent-red);background:none;padding:4px 8px;" onclick="event.stopPropagation();deleteJournal('${j.id}')">ğŸ—‘</button>
          </div>
        </div>
        <div style="margin-top:10px;font-size:13px;color:var(--text-secondary);white-space:pre-wrap;line-height:1.6;">${j.entry}</div>
      </div>
    `).join('');
}

// ============================================================
// HEALTHY HABITS
// ============================================================
function navHabitDate(dir) {
  if (dir === 0) {
    habitViewDate = new Date().toISOString().split('T')[0];
  } else {
    const d = new Date(habitViewDate + 'T12:00:00');
    d.setDate(d.getDate() + dir);
    const today = new Date().toISOString().split('T')[0];
    if (d.toISOString().split('T')[0] > today) return; // no future
    habitViewDate = d.toISOString().split('T')[0];
  }
  renderHabits();
}

function renderHabits() {
  const viewDate = habitViewDate;
  const today = new Date().toISOString().split('T')[0];
  const isToday = viewDate === today;
  const habits = APP.habits || [];
  const log = APP.habitLog || {};
  const dateChecked = log[viewDate] || [];

  // Date button label
  const btn = document.getElementById('habitDateBtn');
  if (isToday) { btn.textContent = 'Today'; }
  else {
    const d = new Date(viewDate + 'T12:00:00');
    btn.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  const grid = document.getElementById('habitsGrid');
  const noMsg = document.getElementById('noHabitsMsg');
  const weekRow = document.getElementById('habitsWeekRow');

  if (habits.length === 0) {
    grid.style.display = 'none'; weekRow.style.display = 'none'; noMsg.style.display = 'block';
    document.getElementById('habitsSubtitle').textContent = 'Add habits in Settings to get started';
    document.getElementById('habitsPctText').textContent = 'â€”';
    document.getElementById('habitsRingProgress').setAttribute('stroke-dashoffset', '119.4');
    return;
  }

  grid.style.display = 'grid'; weekRow.style.display = 'flex'; noMsg.style.display = 'none';

  grid.innerHTML = habits.map(h => {
    const checked = dateChecked.includes(h.id);
    const streak = getHabitStreak(h.id);
    let weekDots = '';
    for (let i = 6; i >= 0; i--) {
      const d = new Date(viewDate + 'T12:00:00'); d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      const dayLabel = d.toLocaleDateString('en-US', { weekday: 'narrow' });
      const done = (log[dateStr] || []).includes(h.id);
      const isCurrent = i === 0;
      const cls = done ? 'done' : (isCurrent ? 'today' : 'missed');
      weekDots += `<div class="habit-week-dot ${cls}" title="${dateStr}">${dayLabel}</div>`;
    }
    return `<div class="habit-card ${checked ? 'checked' : ''}" onclick="toggleHabit('${h.id}')" id="hcard-${h.id}">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="habit-check">${checked ? 'âœ“' : ''}</div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:6px;"><span style="font-size:16px;">${h.emoji}</span><span style="font-size:13px;font-weight:600;">${h.name}</span></div>
          <div class="habit-week">${weekDots}</div>
        </div>
        <div class="habit-streak-badge ${streak > 0 ? 'streak-fire' : 'streak-none'}">${streak > 0 ? 'ğŸ”¥' : ''} ${streak}d</div>
      </div>
    </div>`;
  }).join('');

  const checkedCount = dateChecked.filter(id => habits.find(h => h.id === id)).length;
  const pct = Math.round((checkedCount / habits.length) * 100);
  document.getElementById('habitsPctText').textContent = pct + '%';
  const circ = 119.4;
  document.getElementById('habitsRingProgress').setAttribute('stroke-dashoffset', circ * (1 - pct / 100));
  document.getElementById('habitsSubtitle').textContent = `${checkedCount} of ${habits.length} complete` + (isToday ? ' today' : ` on ${viewDate}`);

  // Weekly summary
  let weekSummary = '';
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    const dayLabel = d.toLocaleDateString('en-US', { weekday: 'narrow' });
    const dayLog = log[dateStr] || [];
    const dayChecked = dayLog.filter(id => habits.find(h => h.id === id)).length;
    const dayPct = Math.round((dayChecked / habits.length) * 100);
    const bg = dayPct === 100 ? 'rgba(52,211,153,0.3)' : dayPct > 0 ? 'rgba(52,211,153,0.12)' : 'var(--bg-input)';
    const color = dayPct === 100 ? 'var(--accent-green)' : dayPct > 0 ? 'rgba(52,211,153,0.6)' : 'var(--text-muted)';
    weekSummary += `<div style="width:28px;height:28px;border-radius:6px;background:${bg};display:flex;flex-direction:column;align-items:center;justify-content:center;${i === 0 ? 'border:1px solid var(--accent-blue);' : ''}" title="${dateStr}: ${dayPct}%"><div style="font-size:8px;font-weight:600;color:${color};">${dayLabel}</div><div style="font-size:9px;font-weight:700;color:${color};">${dayPct}%</div></div>`;
  }
  document.getElementById('habitsWeekSummary').innerHTML = weekSummary;

  let longestStreak = 0, tempStreak = 0;
  for (let i = 0; i < 365; i++) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    const dayLog = log[dateStr] || [];
    if (dayLog.filter(id => habits.find(h => h.id === id)).length === habits.length && habits.length > 0) {
      tempStreak++; longestStreak = Math.max(longestStreak, tempStreak);
    } else if (i === 0) { continue; } else { tempStreak = 0; }
  }
  document.getElementById('habitsBestStreak').textContent = longestStreak + ' days';
}

function toggleHabit(habitId) {
  if (!APP.habitLog) APP.habitLog = {};
  if (!APP.habitLog[habitViewDate]) APP.habitLog[habitViewDate] = [];

  const idx = APP.habitLog[habitViewDate].indexOf(habitId);
  const wasChecked = idx >= 0;
  if (wasChecked) { APP.habitLog[habitViewDate].splice(idx, 1); }
  else { APP.habitLog[habitViewDate].push(habitId); }
  saveData();
  renderHabits();

  // Checkmark animation
  if (!wasChecked) {
    const card = document.getElementById('hcard-' + habitId);
    if (card) { card.classList.add('just-checked'); setTimeout(() => card.classList.remove('just-checked'), 600); }
  }
}

function getHabitStreak(habitId) {
  const log = APP.habitLog || {};
  let streak = 0;
  const d = new Date();
  for (let i = 0; i < 365; i++) {
    const dateStr = d.toISOString().split('T')[0];
    const dayLog = log[dateStr] || [];
    if (dayLog.includes(habitId)) {
      streak++;
      d.setDate(d.getDate() - 1);
    } else if (i === 0) {
      d.setDate(d.getDate() - 1);
      continue; // Today may not be done yet
    } else {
      break;
    }
  }
  return streak;
}

function addHabit() {
  const emoji = document.getElementById('newHabitEmoji').value.trim() || 'âœ…';
  const name = document.getElementById('newHabitName').value.trim();
  if (!name) { toast('Enter a habit name', 'error'); return; }

  // Check for duplicate
  if (APP.habits.find(h => h.name.toLowerCase() === name.toLowerCase())) {
    toast('Habit already exists', 'error'); return;
  }

  APP.habits.push({ id: uid(), emoji, name });
  saveData();
  document.getElementById('newHabitEmoji').value = '';
  document.getElementById('newHabitName').value = '';
  toast(`"${name}" habit added`);
  renderSettingsHabits();
  renderHabits();
}

function quickAddHabit(emoji, name) {
  if (APP.habits.find(h => h.name.toLowerCase() === name.toLowerCase())) {
    toast('Already added', 'info'); return;
  }
  APP.habits.push({ id: uid(), emoji, name });
  saveData();
  toast(`"${name}" added`);
  renderSettingsHabits();
  renderHabits();
}

function removeHabit(id) {
  const h = APP.habits.find(x => x.id === id);
  if (!confirm(`Remove "${h ? h.name : 'this habit'}"? Streak data will be preserved.`)) return;
  APP.habits = APP.habits.filter(x => x.id !== id);
  saveData();
  toast('Habit removed', 'info');
  renderSettingsHabits();
  renderHabits();
}

function moveHabit(id, dir) {
  const idx = APP.habits.findIndex(h => h.id === id);
  if (idx < 0) return;
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= APP.habits.length) return;
  [APP.habits[idx], APP.habits[newIdx]] = [APP.habits[newIdx], APP.habits[idx]];
  saveData();
  renderSettingsHabits();
  renderHabits();
}

function renderSettingsHabits() {
  const container = document.getElementById('settingsHabitsList');
  if (!APP.habits || APP.habits.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-secondary);font-size:13px;">No habits added yet. Use the form above or quick-add presets.</div>';
    return;
  }
  container.innerHTML = APP.habits.map((h, i) => {
    const streak = getHabitStreak(h.id);
    return `<div class="habit-list-item" draggable="true" data-habit-idx="${i}">
      <span style="font-size:14px;cursor:grab;color:var(--text-muted);">â˜°</span>
      <span style="font-size:20px;">${h.emoji}</span>
      <div style="flex:1;"><div style="font-size:13px;font-weight:600;">${h.name}</div><div style="font-size:11px;color:var(--text-muted);">Streak: ${streak} day${streak !== 1 ? 's' : ''}</div></div>
      <button class="btn btn-sm" style="color:var(--accent-red);background:none;padding:4px 8px;" onclick="removeHabit('${h.id}')" title="Remove">ğŸ—‘</button>
    </div>`;
  }).join('');

  // Drag-and-drop
  let dragIdx = null;
  container.querySelectorAll('.habit-list-item').forEach(item => {
    item.addEventListener('dragstart', e => {
      dragIdx = parseInt(item.dataset.habitIdx);
      item.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', () => { item.classList.remove('dragging'); container.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); });
    item.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; item.classList.add('drag-over'); });
    item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
    item.addEventListener('drop', e => {
      e.preventDefault();
      const dropIdx = parseInt(item.dataset.habitIdx);
      if (dragIdx !== null && dragIdx !== dropIdx) {
        const moved = APP.habits.splice(dragIdx, 1)[0];
        APP.habits.splice(dropIdx, 0, moved);
        saveData();
        renderSettingsHabits();
        renderHabits();
      }
      item.classList.remove('drag-over');
    });
  });
}

// ============================================================
// THEME TOGGLE
// ============================================================
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  document.getElementById('themeToggleBtn').textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('vt_theme', next);
  // Recreate charts with new theme colors
  Object.values(charts).forEach(c => { if (c && c.destroy) c.destroy(); });
  charts = {};
  refreshCurrentTab(document.querySelector('.tab-content.active')?.id?.replace('tab-', '') || 'dashboard');
}
(function() {
  const saved = localStorage.getItem('vt_theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
    const btn = document.getElementById('themeToggleBtn');
    if (btn) btn.textContent = saved === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  }
})();

// ============================================================
// WATER TRACKER
// ============================================================
function renderWater() {
  const today = new Date().toISOString().split('T')[0];
  if (!APP.waterLog) APP.waterLog = {};
  const todayOz = APP.waterLog[today] || 0;
  const goal = APP.waterGoal || 128;

  document.getElementById('waterGoalInput').value = goal;
  document.getElementById('waterOzDisplay').textContent = todayOz;
  document.getElementById('waterGoalLabel').textContent = `of ${goal} oz`;

  // Ring progress
  const pct = Math.min(1, todayOz / goal);
  document.getElementById('waterRingProgress').setAttribute('stroke-dashoffset', 439.8 * (1 - pct));

  // Glass grid (8oz each)
  const glassCount = Math.ceil(goal / 8);
  const filledCount = Math.floor(todayOz / 8);
  let glasses = '';
  for (let i = 0; i < glassCount; i++) {
    glasses += `<div class="water-glass ${i < filledCount ? 'filled' : ''}" onclick="setWaterGlasses(${(i + 1) * 8})" title="${(i + 1) * 8} oz">${i < filledCount ? 'ğŸ’§' : 'â—‹'}</div>`;
  }
  document.getElementById('waterGlasses').innerHTML = glasses;

  // 7-day chart
  const labels = [], data = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = d.toISOString().split('T')[0];
    labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
    data.push(APP.waterLog[ds] || 0);
  }

  if (charts.water) charts.water.destroy();
  charts.water = new Chart(document.getElementById('waterChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data, backgroundColor: data.map(v => v >= goal ? 'rgba(34,211,238,0.6)' : 'rgba(34,211,238,0.2)'),
        borderColor: 'rgba(34,211,238,0.8)', borderWidth: 1, borderRadius: 4
      }]
    },
    options: {
      responsive: true, plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8b8fa8' } },
        x: { grid: { display: false }, ticks: { color: '#8b8fa8' } }
      }
    }
  });

  // Stats
  const weekTotal = data.reduce((a, b) => a + b, 0);
  document.getElementById('waterWeekAvg').textContent = Math.round(weekTotal / 7) + ' oz';
  let streak = 0;
  for (let i = 0; i < 365; i++) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = d.toISOString().split('T')[0];
    if ((APP.waterLog[ds] || 0) >= goal) streak++;
    else if (i === 0) continue;
    else break;
  }
  document.getElementById('waterStreak').textContent = streak;
}

function addWater(oz) {
  const today = new Date().toISOString().split('T')[0];
  if (!APP.waterLog) APP.waterLog = {};
  APP.waterLog[today] = Math.max(0, (APP.waterLog[today] || 0) + oz);
  saveData(); renderWater();
}

function setWaterGlasses(oz) {
  const today = new Date().toISOString().split('T')[0];
  if (!APP.waterLog) APP.waterLog = {};
  APP.waterLog[today] = oz;
  saveData(); renderWater();
}

function saveWaterGoal() {
  APP.waterGoal = parseInt(document.getElementById('waterGoalInput').value) || 128;
  saveData(); renderWater();
}

// ============================================================
// BMI GAUGE
// ============================================================
function renderBMIGauge() {
  const wSorted = [...APP.weight].sort((a, b) => b.date.localeCompare(a.date));
  if (wSorted.length === 0 || !wSorted[0].bmi) return;
  const bmi = wSorted[0].bmi;
  document.getElementById('bmiValue').textContent = bmi;
  // Position marker: BMI range 15-40 mapped to 0-100%
  const pct = Math.max(0, Math.min(100, ((bmi - 15) / 25) * 100));
  document.getElementById('bmiMarker').style.left = pct + '%';
  let cat = '';
  if (bmi < 18.5) cat = 'Underweight';
  else if (bmi < 25) cat = 'Normal';
  else if (bmi < 30) cat = 'Overweight';
  else cat = 'Obese';
  document.getElementById('bmiCategory').textContent = cat;
}

// ============================================================
// GOAL PACE
// ============================================================
function renderGoalPace() {
  const container = document.getElementById('goalPaceContent');
  const wSorted = [...APP.weight].sort((a, b) => a.date.localeCompare(b.date)).filter(w => w.weight > 0);
  if (wSorted.length < 2) { container.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;">Need at least 2 weight entries</div>'; return; }

  const startW = APP.settings.startWeight || wSorted[0].weight;
  const goalW = APP.settings.goalWeight || 170;
  const latest = wSorted[wSorted.length - 1];
  const first = wSorted[0];
  const days = Math.max(1, Math.ceil((new Date(latest.date) - new Date(first.date)) / 86400000));
  const lost = startW - latest.weight;
  const lossPerDay = lost / days;
  const remaining = latest.weight - goalW;

  if (lossPerDay <= 0) {
    container.innerHTML = `<div style="font-size:36px;margin-bottom:8px;">ğŸ“Š</div><div style="font-size:13px;color:var(--text-secondary);">Currently gaining â€” adjust habits to start losing</div>`;
    return;
  }

  const daysToGoal = Math.ceil(remaining / lossPerDay);
  const goalDate = new Date(); goalDate.setDate(goalDate.getDate() + daysToGoal);
  const dateStr = goalDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

  container.innerHTML = `
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">At your current rate of <strong style="color:var(--accent-green);">${(lossPerDay * 7).toFixed(1)} lbs/week</strong></div>
    <div style="font-size:13px;margin-bottom:16px;">You'll hit <strong style="color:var(--accent-purple);font-size:18px;">${goalW} lbs</strong> by</div>
    <div style="font-size:22px;font-weight:700;color:var(--accent-blue);">${dateStr}</div>
    <div style="font-size:12px;color:var(--text-muted);margin-top:6px;">${remaining.toFixed(1)} lbs remaining Â· ~${daysToGoal} days</div>
    <div class="progress-bar" style="margin-top:12px;"><div class="progress-fill" style="width:${Math.min(100, (lost / (startW - goalW)) * 100).toFixed(1)}%;background:var(--gradient-green);"></div></div>
    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${((lost / (startW - goalW)) * 100).toFixed(1)}% to goal</div>
  `;
}

// ============================================================
// MILESTONES
// ============================================================
function renderMilestones() {
  const container = document.getElementById('milestoneBanner');
  const wSorted = [...APP.weight].sort((a, b) => b.date.localeCompare(a.date));
  const startW = APP.settings.startWeight || 209.8;
  const latest = wSorted.length > 0 ? wSorted[0].weight : startW;
  const totalLost = startW - latest;

  const fasts = APP.fasting || [];
  const habits = APP.habits || [];
  const log = APP.habitLog || {};

  // Calculate habit streak
  let habitStreak = 0;
  for (let i = 1; i < 365; i++) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = d.toISOString().split('T')[0];
    const dayLog = log[ds] || [];
    if (habits.length > 0 && dayLog.filter(id => habits.find(h => h.id === id)).length === habits.length) habitStreak++;
    else break;
  }

  const milestones = [
    { icon: 'ğŸ', name: 'First Entry', earned: wSorted.length > 0 },
    { icon: 'âš–ï¸', name: '5 lbs Lost', earned: totalLost >= 5 },
    { icon: 'ğŸ”¥', name: '10 lbs Lost', earned: totalLost >= 10 },
    { icon: 'ğŸ’ª', name: '20 lbs Lost', earned: totalLost >= 20 },
    { icon: 'ğŸ†', name: '30 lbs Lost', earned: totalLost >= 30 },
    { icon: 'â³', name: 'First Fast', earned: fasts.length > 0 },
    { icon: 'ğŸ“…', name: '7-Day Habit Streak', earned: habitStreak >= 7 },
    { icon: 'ğŸŒŸ', name: '30-Day Habit Streak', earned: habitStreak >= 30 },
    { icon: 'ğŸ’§', name: 'Water Warrior (7-day)', earned: (() => { let s = 0; for (let i = 1; i <= 7; i++) { const d = new Date(); d.setDate(d.getDate() - i); if ((APP.waterLog?.[d.toISOString().split('T')[0]] || 0) >= (APP.waterGoal || 128)) s++; else break; } return s >= 7; })() },
  ];

  const earned = milestones.filter(m => m.earned);
  if (earned.length === 0) { container.style.display = 'none'; return; }
  container.style.display = 'flex';
  container.innerHTML = earned.map(m => `<div class="badge earned"><span class="badge-icon">${m.icon}</span>${m.name}</div>`).join('');
}

// ============================================================
// WEEKLY DIGEST (shows on Mondays)
// ============================================================
function renderWeeklyDigest() {
  const container = document.getElementById('weeklyDigest');
  const today = new Date();
  const isMonday = today.getDay() === 1;
  // Show on Mondays or if user hasn't seen it (demo: always compute)
  if (!isMonday && !container.dataset.forced) { container.style.display = 'none'; return; }

  // Last week range
  const lastSun = new Date(today); lastSun.setDate(today.getDate() - today.getDay());
  const lastMon = new Date(lastSun); lastMon.setDate(lastSun.getDate() - 6);
  const lmStr = lastMon.toISOString().split('T')[0];
  const lsStr = lastSun.toISOString().split('T')[0];

  // Weight change
  const wLast = [...APP.weight].filter(w => w.date >= lmStr && w.date <= lsStr).sort((a, b) => b.date.localeCompare(a.date));
  const wPrev = [...APP.weight].filter(w => w.date < lmStr).sort((a, b) => b.date.localeCompare(a.date));
  let weightLine = '';
  if (wLast.length > 0 && wPrev.length > 0) {
    const diff = wPrev[0].weight - wLast[0].weight;
    weightLine = `<div style="margin-bottom:6px;">âš–ï¸ Weight: <strong>${diff > 0 ? 'â†“' : 'â†‘'} ${Math.abs(diff).toFixed(1)} lbs</strong> last week (${wLast[0].weight} lbs)</div>`;
  }

  // Habit completion
  const habits = APP.habits || [];
  let habitDays = 0, habitTotal = 0;
  for (let i = 0; i < 7; i++) {
    const d = new Date(lastMon); d.setDate(lastMon.getDate() + i);
    const ds = d.toISOString().split('T')[0];
    const dayLog = APP.habitLog?.[ds] || [];
    if (habits.length > 0) { habitTotal += habits.length; habitDays += dayLog.filter(id => habits.find(h => h.id === id)).length; }
  }
  const habitPct = habitTotal > 0 ? Math.round((habitDays / habitTotal) * 100) : 0;
  const habitLine = habits.length > 0 ? `<div style="margin-bottom:6px;">âœ… Habit completion: <strong>${habitPct}%</strong> last week</div>` : '';

  // Steps
  const eLast = APP.exercise.filter(e => e.date >= lmStr && e.date <= lsStr);
  const stepsLine = eLast.length > 0 ? `<div style="margin-bottom:6px;">ğŸ‘Ÿ Avg steps: <strong>${Math.round(eLast.reduce((s, e) => s + (e.steps || 0), 0) / eLast.length).toLocaleString()}</strong>/day</div>` : '';

  // Water
  let waterTotal = 0, waterDays = 0;
  for (let i = 0; i < 7; i++) {
    const d = new Date(lastMon); d.setDate(lastMon.getDate() + i);
    const ds = d.toISOString().split('T')[0];
    const w = APP.waterLog?.[ds] || 0;
    waterTotal += w;
    if (w >= (APP.waterGoal || 128)) waterDays++;
  }
  const waterLine = waterTotal > 0 ? `<div>ğŸ’§ Water: avg ${Math.round(waterTotal / 7)} oz/day, hit goal ${waterDays}/7 days</div>` : '';

  if (!weightLine && !habitLine && !stepsLine && !waterLine) { container.style.display = 'none'; return; }

  container.style.display = 'block';
  container.innerHTML = `<h3 style="font-size:14px;font-weight:700;margin-bottom:10px;">ğŸ“‹ Last Week's Recap</h3>${weightLine}${habitLine}${stepsLine}${waterLine}`;
}

// ============================================================
// IMPORT FROM EXCEL
// ============================================================
function importExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      let imported = { weight: 0, glucose: 0, exercise: 0, fasting: 0 };

      // Weight Loss sheet
      const wSheet = wb.Sheets['Weight Loss'];
      if (wSheet) {
        const rows = XLSX.utils.sheet_to_json(wSheet);
        rows.forEach(r => {
          const date = r['Date'] || r['date'];
          if (!date) return;
          const dateStr = typeof date === 'number' ? excelDateToStr(date) : String(date).slice(0, 10);
          if (APP.weight.find(w => w.date === dateStr)) return;
          APP.weight.push({ id: uid(), date: dateStr, weight: r['Weight'] || 0, bmi: r['BMI'] || '', bodyFat: r['Body Fat %'] || '', fatFreeWeight: r['Fat-free Body Weight'] || r['Fat-free Weight'] || '', subFat: r['Subcutaneous Fat'] || '', visceral: r['Visceral Fat'] || '', water: r['Body Water %'] || '', skeletal: r['Skeletal Muscle %'] || '', muscleMass: r['Muscle Mass'] || '', bone: r['Bone Mass'] || '', protein: r['Protein %'] || '', bmr: r['BMR'] || '', metAge: r['Metabolic Age'] || '', comments: r['Comments'] || '' });
          imported.weight++;
        });
      }

      // Glucose sheet
      const gSheet = wb.Sheets['Glucose'];
      if (gSheet) {
        const rows = XLSX.utils.sheet_to_json(gSheet);
        rows.forEach(r => {
          const date = r['Date'] || r['date'];
          if (!date) return;
          const dateStr = typeof date === 'number' ? excelDateToStr(date) : String(date).slice(0, 10);
          const glucose = r['Glucose'] || 0;
          const ketones = r['Ketones'] || 0;
          const gki = ketones > 0 ? parseFloat(((glucose / 18) / ketones).toFixed(2)) : 0;
          APP.glucose.push({ id: uid(), date: dateStr, time: r['Time'] || '', glucose, ketones, gki: r['GKI Level'] || r['GKI'] || gki, comments: r['Comments'] || '' });
          imported.glucose++;
        });
      }

      // Exercise sheet
      const eSheet = wb.Sheets['Exercise'];
      if (eSheet) {
        const rows = XLSX.utils.sheet_to_json(eSheet);
        rows.forEach(r => {
          const date = r['Date'] || r['date'];
          if (!date) return;
          const dateStr = typeof date === 'number' ? excelDateToStr(date) : String(date).slice(0, 10);
          APP.exercise.push({ id: uid(), date: dateStr, steps: r['Steps'] || 0, miles: r['Miles'] || 0, avgHR: r['AVG HR'] || r['Avg HR'] || 0, restHR: r['Rest HR'] || 0, vo2: r['VO2 Max'] || 0, notes: '' });
          imported.exercise++;
        });
      }

      // Fasting sheet
      const fSheet = wb.Sheets['Fasting'];
      if (fSheet) {
        const rows = XLSX.utils.sheet_to_json(fSheet);
        rows.forEach(r => {
          const date = r['Date'] || r['date'];
          if (!date) return;
          const dateStr = typeof date === 'number' ? excelDateToStr(date) : String(date).slice(0, 10);
          APP.fasting.push({ id: uid(), date: dateStr, status: r['Status'] || 'OMAD', duration: r['Duration (hrs)'] || 0, completed: r['Completed'] === 'Yes' ? 'yes' : 'no', notes: r['Notes'] || '' });
          imported.fasting++;
        });
      }

      saveData();
      toast(`Imported: ${imported.weight} weight, ${imported.glucose} glucose, ${imported.exercise} exercise, ${imported.fasting} fasting`);
      renderDashboard();
    } catch(err) {
      toast('Import failed: ' + err.message, 'error');
      console.error(err);
    }
  };
  reader.readAsArrayBuffer(file);
  event.target.value = '';
}

function excelDateToStr(serial) {
  const d = new Date((serial - 25569) * 86400000);
  return d.toISOString().split('T')[0];
}

// ============================================================
// PDF SUMMARY REPORT
// ============================================================
function generatePDFReport() {
  const wSorted = [...APP.weight].sort((a, b) => b.date.localeCompare(a.date));
  const latest = wSorted.length > 0 ? wSorted[0] : null;
  const startW = APP.settings.startWeight || 209.8;
  const goalW = APP.settings.goalWeight || 170;
  const totalLost = latest ? (startW - latest.weight) : 0;
  const remaining = latest ? (latest.weight - goalW) : 0;

  const gSorted = [...APP.glucose].sort((a, b) => b.date.localeCompare(a.date));
  const eSorted = [...APP.exercise].sort((a, b) => b.date.localeCompare(a.date));
  const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

  // Habits stats
  const habits = APP.habits || [];
  let last30Completion = 0, last30Total = 0;
  for (let i = 0; i < 30; i++) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = d.toISOString().split('T')[0];
    const dayLog = APP.habitLog?.[ds] || [];
    last30Total += habits.length;
    last30Completion += dayLog.filter(id => habits.find(h => h.id === id)).length;
  }
  const habitPct = last30Total > 0 ? Math.round((last30Completion / last30Total) * 100) : 0;

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>VitalTrack Health Report</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto;color:#1a1a2e;font-size:13px}
h1{font-size:24px;margin-bottom:4px;color:#1a1a2e}h2{font-size:16px;margin:20px 0 10px;color:#333;border-bottom:2px solid #4a7cff;padding-bottom:4px}
.subtitle{color:#666;font-size:12px;margin-bottom:20px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.box{border:1px solid #ddd;border-radius:8px;padding:12px}.box-label{font-size:10px;color:#888;text-transform:uppercase;margin-bottom:2px}
.box-value{font-size:20px;font-weight:bold;color:#333}
.box-sm .box-value{font-size:16px}
table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
th{text-align:left;padding:6px 8px;background:#f0f0f0;font-weight:600;font-size:10px;text-transform:uppercase}
td{padding:6px 8px;border-bottom:1px solid #eee}
.footer{margin-top:30px;font-size:10px;color:#999;text-align:center;border-top:1px solid #eee;padding-top:10px}
@media print{body{padding:20px}}
</style></head><body>
<h1>âš¡ VitalTrack Health Report</h1>
<div class="subtitle">Generated: ${today}</div>

<h2>Weight & Body Composition</h2>
<div class="grid">
  <div class="box"><div class="box-label">Starting Weight</div><div class="box-value">${startW} lbs</div></div>
  <div class="box"><div class="box-label">Current Weight</div><div class="box-value">${latest ? latest.weight : 'â€”'} lbs</div></div>
  <div class="box"><div class="box-label">Total Lost</div><div class="box-value">${totalLost.toFixed(1)} lbs</div></div>
  <div class="box"><div class="box-label">Goal Weight</div><div class="box-value">${goalW} lbs</div></div>
  <div class="box"><div class="box-label">BMI</div><div class="box-value">${latest?.bmi || 'â€”'}</div></div>
  <div class="box"><div class="box-label">Body Fat %</div><div class="box-value">${latest?.bodyFat || 'â€”'}%</div></div>
  <div class="box"><div class="box-label">Remaining to Goal</div><div class="box-value">${remaining.toFixed(1)} lbs</div></div>
  <div class="box"><div class="box-label">Skeletal Muscle %</div><div class="box-value">${latest?.skeletal || 'â€”'}%</div></div>
</div>

<h2>Recent Weight History</h2>
<table><tr><th>Date</th><th>Weight</th><th>BMI</th><th>Body Fat</th><th>Water %</th></tr>
${wSorted.slice(0, 10).map(w => `<tr><td>${w.date}</td><td>${w.weight}</td><td>${w.bmi || 'â€”'}</td><td>${w.bodyFat || 'â€”'}%</td><td>${w.water || 'â€”'}%</td></tr>`).join('')}
</table>

<h2>Glucose & Ketones</h2>
<div class="grid">
  <div class="box box-sm"><div class="box-label">Latest Glucose</div><div class="box-value">${gSorted[0]?.glucose || 'â€”'} mg/dL</div></div>
  <div class="box box-sm"><div class="box-label">Latest GKI</div><div class="box-value">${gSorted[0]?.gki || 'â€”'}</div></div>
</div>
<table><tr><th>Date</th><th>Glucose</th><th>Ketones</th><th>GKI</th><th>Notes</th></tr>
${gSorted.slice(0, 8).map(g => `<tr><td>${g.date}</td><td>${g.glucose}</td><td>${g.ketones}</td><td>${g.gki}</td><td>${g.comments || ''}</td></tr>`).join('')}
</table>

<h2>Exercise & Activity</h2>
<table><tr><th>Date</th><th>Steps</th><th>Miles</th><th>Avg HR</th><th>Rest HR</th><th>VO2</th></tr>
${eSorted.slice(0, 8).map(e => `<tr><td>${e.date}</td><td>${e.steps?.toLocaleString()}</td><td>${e.miles}</td><td>${e.avgHR}</td><td>${e.restHR}</td><td>${e.vo2}</td></tr>`).join('')}
</table>

<h2>Fasting Summary</h2>
<div class="grid">
  <div class="box box-sm"><div class="box-label">Total OMAD Days</div><div class="box-value">${APP.fasting.filter(f => f.status === 'OMAD').length}</div></div>
  <div class="box box-sm"><div class="box-label">Total Fasting Days</div><div class="box-value">${APP.fasting.filter(f => f.status === 'Fasting').length}</div></div>
  <div class="box box-sm"><div class="box-label">Total Free Days</div><div class="box-value">${APP.fasting.filter(f => f.status === 'Free Day').length}</div></div>
  <div class="box box-sm"><div class="box-label">30-Day Habit Completion</div><div class="box-value">${habitPct}%</div></div>
</div>

${habits.length > 0 ? `<h2>Healthy Habits (${habits.length} tracked)</h2>
<table><tr><th>Habit</th><th>Current Streak</th></tr>
${habits.map(h => `<tr><td>${h.emoji} ${h.name}</td><td>${getHabitStreak(h.id)} days</td></tr>`).join('')}
</table>` : ''}

<div class="footer">VitalTrack Health Report Â· For informational purposes Â· Generated ${today}</div>
</body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  setTimeout(() => win.print(), 500);
  toast('PDF report opened â€” use Print to save as PDF');
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard() {
  const today = new Date();
  document.getElementById('dashDateLabel').textContent = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

  // Habits
  renderHabits();

  // New features
  renderBMIGauge();
  renderGoalPace();
  renderMilestones();
  renderWeeklyDigest();

  // Stat cards
  const wSorted = [...APP.weight].sort((a, b) => b.date.localeCompare(a.date));
  if (wSorted.length > 0) {
    const latest = wSorted[0];
    const startW = APP.settings.startWeight || wSorted[wSorted.length - 1].weight;
    document.getElementById('dashCurrentWeight').textContent = latest.weight;
    document.getElementById('dashTotalLoss').textContent = (startW - latest.weight).toFixed(1);
    document.getElementById('dashBMI').textContent = latest.bmi || 'â€”';
  }

  const gSorted = [...APP.glucose].sort((a, b) => b.date.localeCompare(a.date));
  if (gSorted.length > 0) { document.getElementById('dashGlucose').textContent = gSorted[0].glucose; }

  const eSorted = [...APP.exercise].sort((a, b) => b.date.localeCompare(a.date)).filter(e => e.steps > 0);
  if (eSorted.length > 0) { document.getElementById('dashSteps').textContent = eSorted[0].steps.toLocaleString(); }

  // Recent activity
  const activities = [];
  APP.weight.slice(-3).forEach(w => activities.push({ date: w.date, icon: 'âš–ï¸', text: `Weight: ${w.weight} lbs`, type: 'weight' }));
  APP.glucose.slice(-3).forEach(g => activities.push({ date: g.date, icon: 'ğŸ©¸', text: `Glucose: ${g.glucose} | GKI: ${g.gki}`, type: 'glucose' }));
  APP.exercise.slice(-3).forEach(e => activities.push({ date: e.date, icon: 'ğŸƒ', text: `${e.steps.toLocaleString()} steps, ${e.miles} mi`, type: 'exercise' }));
  APP.fasting.slice(-3).forEach(f => activities.push({ date: f.date, icon: 'ğŸ•', text: `${f.status} â€” ${f.duration}h`, type: 'fasting' }));
  activities.sort((a, b) => b.date.localeCompare(a.date));

  document.getElementById('dashRecentActivity').innerHTML = activities.slice(0, 8).map(a =>
    `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;background:var(--bg-input);">
      <span style="font-size:16px;">${a.icon}</span>
      <div style="flex:1;font-size:13px;">${a.text}</div>
      <div class="mono" style="font-size:11px;color:var(--text-muted);">${formatDateShort(a.date)}</div>
    </div>`
  ).join('') || '<div style="font-size:13px;color:var(--text-secondary);text-align:center;padding:20px;">No activity yet</div>';

  // Goal progress
  renderDashGoals();

  // Charts
  renderDashCharts();
}

function renderDashGoals() {
  const container = document.getElementById('dashGoalProgress');
  if (APP.goals.length === 0) {
    container.innerHTML = '<div style="font-size:13px;color:var(--text-secondary);text-align:center;padding:20px;">No goals set</div>';
    return;
  }
  container.innerHTML = APP.goals.map(g => {
    const range = Math.abs(g.start - g.target);
    const progress = range > 0 ? Math.min(100, Math.max(0, (Math.abs(g.start - g.current) / range) * 100)) : 0;
    return `<div style="margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;">
        <span>${g.name}</span><span style="font-weight:600;">${progress.toFixed(0)}%</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${progress}%;background:var(--accent-blue);"></div></div>
    </div>`;
  }).join('');
}

function renderDashCharts() {
  // Weight chart
  const wData = [...APP.weight].sort((a, b) => a.date.localeCompare(b.date)).filter(w => w.weight > 0);
  if (charts.dashWeight) charts.dashWeight.destroy();
  if (wData.length > 0) {
    charts.dashWeight = new Chart(document.getElementById('dashWeightChart'), {
      type: 'line',
      data: {
        labels: wData.map(w => formatDateShort(w.date)),
        datasets: [{ label: 'Weight', data: wData.map(w => w.weight), borderColor: '#4a7cff', backgroundColor: 'rgba(74,124,255,0.1)', fill: true, tension: 0.3, pointRadius: 4 }]
      },
      options: { ...simpleChartOpts(), plugins: { legend: { display: false } } }
    });
  }

  // Body comp chart
  if (charts.dashBodyComp) charts.dashBodyComp.destroy();
  if (wData.length > 0) {
    charts.dashBodyComp = new Chart(document.getElementById('dashBodyCompChart'), {
      type: 'line',
      data: {
        labels: wData.map(w => formatDateShort(w.date)),
        datasets: [
          { label: 'Body Fat %', data: wData.map(w => w.bodyFat), borderColor: '#f87171', tension: 0.3, pointRadius: 3 },
          { label: 'Water %', data: wData.map(w => w.water), borderColor: '#22d3ee', tension: 0.3, pointRadius: 3 },
          { label: 'Skeletal Muscle %', data: wData.map(w => w.skeletal), borderColor: '#34d399', tension: 0.3, pointRadius: 3 },
        ]
      },
      options: simpleChartOpts()
    });
  }
}

// ============================================================
// REPORTS
// ============================================================
function renderReports() {
  const rangeDays = document.getElementById('reportRange').value;
  const cutoff = rangeDays === 'all' ? '1900-01-01' : new Date(Date.now() - rangeDays * 86400000).toISOString().split('T')[0];

  // Weight over time
  const wData = [...APP.weight].filter(w => w.date >= cutoff && w.weight > 0).sort((a, b) => a.date.localeCompare(b.date));
  if (charts.reportWeight) charts.reportWeight.destroy();
  if (wData.length > 0) {
    charts.reportWeight = new Chart(document.getElementById('reportWeightChart'), {
      type: 'line',
      data: { labels: wData.map(w => formatDateShort(w.date)), datasets: [{ label: 'Weight', data: wData.map(w => w.weight), borderColor: '#4a7cff', backgroundColor: 'rgba(74,124,255,0.1)', fill: true, tension: 0.3, pointRadius: 4 }] },
      options: simpleChartOpts()
    });
  }

  // Body fat
  if (charts.reportBodyFat) charts.reportBodyFat.destroy();
  if (wData.length > 0) {
    charts.reportBodyFat = new Chart(document.getElementById('reportBodyFatChart'), {
      type: 'line',
      data: { labels: wData.map(w => formatDateShort(w.date)), datasets: [{ label: 'Body Fat %', data: wData.map(w => w.bodyFat), borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.1)', fill: true, tension: 0.3, pointRadius: 4 }] },
      options: simpleChartOpts()
    });
  }

  // Glucose
  const gData = [...APP.glucose].filter(g => g.date >= cutoff).sort((a, b) => a.date.localeCompare(b.date));
  if (charts.reportGlucose) charts.reportGlucose.destroy();
  if (gData.length > 0) {
    charts.reportGlucose = new Chart(document.getElementById('reportGlucoseChart'), {
      type: 'line',
      data: { labels: gData.map(g => formatDateShort(g.date)), datasets: [
        { label: 'Glucose', data: gData.map(g => g.glucose), borderColor: '#f87171', tension: 0.3, pointRadius: 4 },
        { label: 'GKI', data: gData.map(g => g.gki), borderColor: '#fbbf24', tension: 0.3, pointRadius: 4 }
      ] },
      options: simpleChartOpts()
    });
  }

  // Exercise
  const eData = [...APP.exercise].filter(e => e.date >= cutoff && e.steps > 0).sort((a, b) => a.date.localeCompare(b.date));
  if (charts.reportExercise) charts.reportExercise.destroy();
  if (eData.length > 0) {
    charts.reportExercise = new Chart(document.getElementById('reportExerciseChart'), {
      type: 'bar',
      data: { labels: eData.map(e => formatDateShort(e.date)), datasets: [{ label: 'Steps', data: eData.map(e => e.steps), backgroundColor: 'rgba(74,124,255,0.6)', borderRadius: 4 }] },
      options: simpleChartOpts()
    });
  }

  // Weekly averages
  renderWeeklyAverages(cutoff);
}

function renderWeeklyAverages(cutoff) {
  const wData = [...APP.weight].filter(w => w.date >= cutoff && w.weight > 0).sort((a, b) => a.date.localeCompare(b.date));
  if (wData.length === 0) { document.getElementById('weeklyAverages').innerHTML = '<div style="color:var(--text-secondary);font-size:13px;">Not enough data for weekly averages.</div>'; return; }

  const weeks = {};
  wData.forEach(w => {
    const d = new Date(w.date);
    const weekStart = new Date(d); weekStart.setDate(d.getDate() - d.getDay());
    const key = weekStart.toISOString().split('T')[0];
    if (!weeks[key]) weeks[key] = [];
    weeks[key].push(w);
  });

  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;">';
  Object.entries(weeks).forEach(([week, entries]) => {
    const avgW = (entries.reduce((s, e) => s + e.weight, 0) / entries.length).toFixed(1);
    const avgBF = entries.filter(e => e.bodyFat).length > 0 ? (entries.reduce((s, e) => s + (e.bodyFat || 0), 0) / entries.filter(e => e.bodyFat).length).toFixed(1) : 'â€”';
    html += `<div style="padding:12px;background:var(--bg-input);border-radius:8px;">
      <div style="font-size:11px;color:var(--text-muted);">Week of ${formatDate(week)}</div>
      <div style="font-size:16px;font-weight:600;margin-top:4px;">${avgW} lbs avg</div>
      <div style="font-size:12px;color:var(--text-secondary);">Body Fat: ${avgBF}% â€¢ ${entries.length} entries</div>
    </div>`;
  });
  html += '</div>';
  document.getElementById('weeklyAverages').innerHTML = html;
}

// ============================================================
// SETTINGS
// ============================================================
function renderSettings() {
  document.getElementById('setWeightUnit').value = APP.settings.weightUnit;
  document.getElementById('setMeasureUnit').value = APP.settings.measureUnit;
  document.getElementById('setHeight').value = APP.settings.height;
  document.getElementById('setWeightGoal').value = APP.settings.weightGoal;
  document.getElementById('setGoalWeight').value = APP.settings.goalWeight || 170;
  document.getElementById('setStartWeight').value = APP.settings.startWeight;
  renderSettingsHabits();
}

function saveSettings() {
  APP.settings.weightUnit = document.getElementById('setWeightUnit').value;
  APP.settings.measureUnit = document.getElementById('setMeasureUnit').value;
  APP.settings.height = parseFloat(document.getElementById('setHeight').value) || 70;
  APP.settings.weightGoal = parseFloat(document.getElementById('setWeightGoal').value) || 39.8;
  APP.settings.goalWeight = parseFloat(document.getElementById('setGoalWeight').value) || 170;
  APP.settings.startWeight = parseFloat(document.getElementById('setStartWeight').value) || 209.8;
  saveData(); toast('Settings saved');
}

function exportJSON() {
  const blob = new Blob([JSON.stringify(APP, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `vitaltrack_export_${new Date().toISOString().split('T')[0]}.json`;
  a.click(); toast('Data exported as JSON');
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.weight || data.glucose || data.exercise) {
        APP = data;
        saveData();
        toast('Data imported successfully');
        renderDashboard(); updateBadges();
      } else {
        toast('Invalid data format', 'error');
      }
    } catch (err) { toast('Failed to parse file', 'error'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function exportExcel() {
  const wb = XLSX.utils.book_new();

  // ---- Overview Sheet ----
  const wSorted = [...APP.weight].sort((a, b) => a.date.localeCompare(b.date)).filter(w => w.weight > 0);
  const latest = wSorted.length > 0 ? wSorted[wSorted.length - 1] : null;
  const first = wSorted.length > 0 ? wSorted[0] : null;
  const startW = APP.settings.startWeight || (first ? first.weight : 0);
  const goalW = APP.settings.goalWeight || 170;
  const lbsToLose = APP.settings.weightGoal || (startW - goalW);
  const totalLoss = latest ? (startW - latest.weight) : 0;
  const remaining = latest ? (latest.weight - goalW) : lbsToLose;
  const days = first && latest ? Math.max(1, Math.ceil((new Date(latest.date) - new Date(first.date)) / 86400000)) : 1;

  const overviewData = [
    ['VitalTrack â€” Health & Weight Report'],
    ['Generated', new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })],
    [],
    ['WEIGHT SUMMARY'],
    ['Starting Weight', startW, '', 'Goal Weight', goalW],
    ['Current Weight', latest ? latest.weight : 'â€”', '', 'Lbs to Lose', lbsToLose.toFixed(1)],
    ['Current BMI', latest ? latest.bmi : 'â€”', '', 'Total Lost', totalLoss.toFixed(1)],
    ['Current Body Fat %', latest ? latest.bodyFat : 'â€”', '', 'Remaining', remaining.toFixed(1)],
    ['', '', '', 'Avg Loss/Day', (totalLoss / days).toFixed(2)],
    [],
    ['FASTING SUMMARY'],
    ['Total OMAD Days', APP.fasting.filter(f => f.status === 'OMAD').length],
    ['Total Fasting Days', APP.fasting.filter(f => f.status === 'Fasting').length],
    ['Total Free Days', APP.fasting.filter(f => f.status === 'Free Day').length],
    [],
    ['GLUCOSE SUMMARY'],
    ['Total Readings', APP.glucose.length],
    ['Latest Glucose', APP.glucose.length > 0 ? [...APP.glucose].sort((a, b) => b.date.localeCompare(a.date))[0].glucose + ' mg/dL' : 'â€”'],
    ['Latest GKI', APP.glucose.length > 0 ? [...APP.glucose].sort((a, b) => b.date.localeCompare(a.date))[0].gki : 'â€”'],
    [],
    ['EXERCISE SUMMARY'],
    ['Total Entries', APP.exercise.filter(e => e.steps > 0).length],
    ['Total Steps', APP.exercise.reduce((s, e) => s + (e.steps || 0), 0)],
    ['Total Miles', APP.exercise.reduce((s, e) => s + (e.miles || 0), 0).toFixed(1)],
  ];
  const wsOverview = XLSX.utils.aoa_to_sheet(overviewData);
  wsOverview['!cols'] = [{ wch: 20 }, { wch: 16 }, { wch: 4 }, { wch: 18 }, { wch: 14 }];
  XLSX.utils.book_append_sheet(wb, wsOverview, 'Overview');

  // ---- Weight Loss Sheet ----
  const wHeaders = ['Date', 'Weight', 'Gain/Loss', 'BMI', 'Body Fat %', 'Gain/Loss', 'Fat-free Body Weight', 'Subcutaneous Fat', 'Gain/Loss', 'Visceral Fat', 'Body Water %', 'Skeletal Muscle %', 'Muscle Mass', 'Bone Mass', 'Protein %', 'BMR', 'Metabolic Age', 'Comments'];
  const wAll = [...APP.weight].sort((a, b) => a.date.localeCompare(b.date));
  const wData = wAll.map((w, i) => {
    const prev = wAll[i - 1];
    const wChange = prev ? parseFloat((prev.weight - w.weight).toFixed(1)) : '';
    const bfChange = prev && prev.bodyFat && w.bodyFat ? parseFloat((prev.bodyFat - w.bodyFat).toFixed(1)) : '';
    const sfChange = prev && prev.subFat && w.subFat ? parseFloat((prev.subFat - w.subFat).toFixed(1)) : '';
    return [w.date, w.weight || '', wChange, w.bmi || '', w.bodyFat || '', bfChange, w.fatFreeWeight || '', w.subFat || '', sfChange, w.visceral || '', w.water || '', w.skeletal || '', w.muscleMass || '', w.bone || '', w.protein || '', w.bmr || '', w.metAge || '', w.comments || ''];
  });
  const ws1 = XLSX.utils.aoa_to_sheet([wHeaders, ...wData]);
  ws1['!cols'] = [{ wch: 12 }, { wch: 8 }, { wch: 10 }, { wch: 6 }, { wch: 10 }, { wch: 10 }, { wch: 16 }, { wch: 14 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 16 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 6 }, { wch: 12 }, { wch: 24 }];
  XLSX.utils.book_append_sheet(wb, ws1, 'Weight Loss');

  // ---- Glucose Sheet ----
  const gHeaders = ['Date', 'Time', 'Glucose', 'Ketones', 'GKI Level', 'Comments', '', 'GKI', 'Category', 'Detail'];
  const gRef = [
    ['', '', '', '', '', '', '', '< 1', 'Highest Therapeutic Ketosis', 'Requires medical supervision'],
    ['', '', '', '', '', '', '', '1.0 to 3.0', 'Therapeutic Ketosis', 'Cancer/neurological management'],
    ['', '', '', '', '', '', '', '3.0 to 6.0', 'Moderate Ketosis', 'Diabetes/insulin resistance/obesity'],
    ['', '', '', '', '', '', '', '6.0 to 9.0', 'Mild Ketosis', 'Weight loss & optimal health'],
    ['', '', '', '', '', '', '', '9.0 >', 'Not in Ketosis', 'N/A'],
  ];
  const gData = [...APP.glucose].sort((a, b) => a.date.localeCompare(b.date)).map(g => [g.date, g.time, g.glucose, g.ketones, g.gki, g.comments]);
  // Merge glucose data rows with reference rows side by side
  const gAllRows = [];
  const maxRows = Math.max(gData.length, gRef.length);
  for (let i = 0; i < maxRows; i++) {
    const dataRow = gData[i] || ['', '', '', '', '', ''];
    const refRow = gRef[i] || ['', '', '', ''];
    gAllRows.push([...dataRow, '', ...(refRow.slice(7))]);
  }
  const ws2 = XLSX.utils.aoa_to_sheet([gHeaders, ...gAllRows]);
  ws2['!cols'] = [{ wch: 12 }, { wch: 8 }, { wch: 8 }, { wch: 8 }, { wch: 10 }, { wch: 28 }, { wch: 2 }, { wch: 12 }, { wch: 26 }, { wch: 44 }];
  XLSX.utils.book_append_sheet(wb, ws2, 'Glucose');

  // ---- Exercise Sheet ----
  const eHeaders = ['Date', 'Steps', 'Miles', '', 'AVG HR', 'Difference', '', 'Rest HR', 'Difference', 'VO2 Max'];
  const eAll = [...APP.exercise].sort((a, b) => a.date.localeCompare(b.date));
  const eData = eAll.map((e, i) => {
    const prev = eAll[i - 1];
    const hrDiff = prev && prev.avgHR && e.avgHR ? e.avgHR - prev.avgHR : '';
    const restDiff = prev && prev.restHR && e.restHR ? e.restHR - prev.restHR : '';
    return [e.date, e.steps || '', e.miles || '', '', e.avgHR || '', hrDiff, '', e.restHR || '', restDiff, e.vo2 || ''];
  });
  const ws3 = XLSX.utils.aoa_to_sheet([eHeaders, ...eData]);
  ws3['!cols'] = [{ wch: 12 }, { wch: 8 }, { wch: 8 }, { wch: 2 }, { wch: 8 }, { wch: 10 }, { wch: 2 }, { wch: 8 }, { wch: 10 }, { wch: 8 }];
  XLSX.utils.book_append_sheet(wb, ws3, 'Exercise');

  // ---- Fasting Sheet ----
  const fHeaders = ['Date', 'Status', 'Duration (hrs)', 'Completed', 'Notes', '', 'Summary', 'Count'];
  const fData = [...APP.fasting].sort((a, b) => a.date.localeCompare(b.date)).map(f => [f.date, f.status, f.duration, f.completed === 'yes' ? 'Yes' : 'No', f.notes || '']);
  // Add summary in cols G-H
  const fSummary = [
    ['Total OMAD Days', APP.fasting.filter(f => f.status === 'OMAD').length],
    ['Total Fasting Days', APP.fasting.filter(f => f.status === 'Fasting').length],
    ['Total Free Days', APP.fasting.filter(f => f.status === 'Free Day').length],
    [],
    ['Current Month OMAD', APP.fasting.filter(f => f.status === 'OMAD' && f.date.startsWith(new Date().toISOString().slice(0, 7))).length],
    ['Current Month Fasting', APP.fasting.filter(f => f.status === 'Fasting' && f.date.startsWith(new Date().toISOString().slice(0, 7))).length],
    ['Current Month Free', APP.fasting.filter(f => f.status === 'Free Day' && f.date.startsWith(new Date().toISOString().slice(0, 7))).length],
  ];
  const fAllRows = [];
  const fMaxRows = Math.max(fData.length, fSummary.length);
  for (let i = 0; i < fMaxRows; i++) {
    const dataRow = fData[i] || ['', '', '', '', ''];
    const sumRow = fSummary[i] || ['', ''];
    fAllRows.push([...dataRow, '', ...sumRow]);
  }
  const ws4 = XLSX.utils.aoa_to_sheet([fHeaders, ...fAllRows]);
  ws4['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 14 }, { wch: 10 }, { wch: 24 }, { wch: 2 }, { wch: 22 }, { wch: 8 }];
  XLSX.utils.book_append_sheet(wb, ws4, 'Fasting');

  // ---- Goals Sheet ----
  const goHeaders = ['Goal Name', 'Category', 'Start Value', 'Current Value', 'Target Value', 'Progress %', 'Target Date', 'Notes'];
  const goData = APP.goals.map(g => {
    const range = Math.abs(g.start - g.target);
    const progress = range > 0 ? Math.min(100, Math.max(0, (Math.abs(g.start - g.current) / range) * 100)).toFixed(1) : 0;
    return [g.name, g.category, g.start, g.current, g.target, progress + '%', g.targetDate || '', g.notes || ''];
  });
  const ws5 = XLSX.utils.aoa_to_sheet([goHeaders, ...goData]);
  ws5['!cols'] = [{ wch: 24 }, { wch: 12 }, { wch: 12 }, { wch: 14 }, { wch: 12 }, { wch: 10 }, { wch: 12 }, { wch: 30 }];
  XLSX.utils.book_append_sheet(wb, ws5, 'Goals');

  // ---- Journal Sheet ----
  const jHeaders = ['Date', 'Category', 'Entry', 'Starred', 'Pinned'];
  const jData = [...APP.journal].sort((a, b) => b.date.localeCompare(a.date)).map(j => [j.date, j.category, j.entry, j.starred ? 'Yes' : 'No', j.pinned ? 'Yes' : 'No']);
  const ws6 = XLSX.utils.aoa_to_sheet([jHeaders, ...jData]);
  ws6['!cols'] = [{ wch: 12 }, { wch: 12 }, { wch: 60 }, { wch: 8 }, { wch: 8 }];
  XLSX.utils.book_append_sheet(wb, ws6, 'Journal');

  // ---- Habits Sheet ----
  const hHeaders = ['Habit', 'Emoji', 'Current Streak (days)'];
  const hData = (APP.habits || []).map(h => [h.name, h.emoji, getHabitStreak(h.id)]);
  const ws7 = XLSX.utils.aoa_to_sheet([hHeaders, ...hData]);
  // Habit log per day
  const hLogHeaders = ['Date'];
  (APP.habits || []).forEach(h => hLogHeaders.push(h.emoji + ' ' + h.name));
  const logDates = Object.keys(APP.habitLog || {}).sort();
  const hLogData = logDates.map(date => {
    const row = [date];
    (APP.habits || []).forEach(h => {
      row.push((APP.habitLog[date] || []).includes(h.id) ? 'âœ“' : '');
    });
    return row;
  });
  if (hLogData.length > 0) {
    XLSX.utils.sheet_add_aoa(ws7, [[]], { origin: -1 });
    XLSX.utils.sheet_add_aoa(ws7, [['DAILY LOG']], { origin: -1 });
    XLSX.utils.sheet_add_aoa(ws7, [hLogHeaders, ...hLogData], { origin: -1 });
  }
  ws7['!cols'] = [{ wch: 24 }, { wch: 6 }, { wch: 20 }];
  XLSX.utils.book_append_sheet(wb, ws7, 'Habits');

  // ---- Water Sheet ----
  const waterHeaders = ['Date', 'Intake (oz)', 'Goal (oz)', 'Met Goal'];
  const waterDates = Object.keys(APP.waterLog || {}).sort();
  const wGoal = APP.waterGoal || 128;
  const waterData = waterDates.map(d => [d, APP.waterLog[d], wGoal, APP.waterLog[d] >= wGoal ? 'Yes' : 'No']);
  const ws8 = XLSX.utils.aoa_to_sheet([waterHeaders, ...waterData]);
  ws8['!cols'] = [{ wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 10 }];
  XLSX.utils.book_append_sheet(wb, ws8, 'Water');

  XLSX.writeFile(wb, `VitalTrack_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
  toast('Exported to Excel â€” 8 sheets');
}

function confirmClearData() {
  if (confirm('âš ï¸ Are you sure you want to delete ALL data? This cannot be undone.')) {
    if (confirm('This will permanently delete all your weight, glucose, exercise, fasting, goals, and journal data. Proceed?')) {
      localStorage.removeItem(DB_KEY);
      APP = defaultData();
      saveData(); renderDashboard(); updateBadges();
      toast('All data cleared', 'info');
    }
  }
}

// ============================================================
// GLOBAL SEARCH
// ============================================================
function globalSearch(query) {
  if (!query || query.length < 2) return;
  const q = query.toLowerCase();
  const results = [];

  APP.weight.forEach(w => {
    if (w.date.includes(q) || w.weight.toString().includes(q) || (w.comments || '').toLowerCase().includes(q)) {
      results.push({ type: 'Weight', date: w.date, text: `${w.weight} lbs â€” ${w.comments || 'No notes'}`, tab: 'weight', id: w.id });
    }
  });
  APP.glucose.forEach(g => {
    if (g.date.includes(q) || g.glucose.toString().includes(q) || (g.comments || '').toLowerCase().includes(q)) {
      results.push({ type: 'Glucose', date: g.date, text: `${g.glucose} mg/dL, GKI: ${g.gki} â€” ${g.comments || ''}`, tab: 'glucose', id: g.id });
    }
  });
  APP.exercise.forEach(e => {
    if (e.date.includes(q) || (e.notes || '').toLowerCase().includes(q)) {
      results.push({ type: 'Exercise', date: e.date, text: `${e.steps} steps, ${e.miles} mi`, tab: 'exercise', id: e.id });
    }
  });
  APP.fasting.forEach(f => {
    if (f.date.includes(q) || f.status.toLowerCase().includes(q) || (f.notes || '').toLowerCase().includes(q)) {
      results.push({ type: 'Fasting', date: f.date, text: `${f.status} â€” ${f.duration}h`, tab: 'fasting', id: f.id });
    }
  });
  APP.journal.forEach(j => {
    if (j.date.includes(q) || j.entry.toLowerCase().includes(q) || j.category.includes(q)) {
      results.push({ type: 'Journal', date: j.date, text: j.entry.slice(0, 80) + '...', tab: 'journal', id: j.id });
    }
  });

  results.sort((a, b) => b.date.localeCompare(a.date));

  document.getElementById('searchResults').innerHTML = results.length === 0 ?
    '<div style="text-align:center;padding:30px;color:var(--text-secondary);">No results found.</div>' :
    results.map(r =>
      `<div class="card" style="padding:12px;cursor:pointer;" onclick="closeModal('searchModal');switchTab('${r.tab}');">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(74,124,255,0.15);color:var(--accent-blue);font-weight:600;">${r.type}</span>
          <span class="mono" style="font-size:11px;color:var(--text-muted);">${formatDate(r.date)}</span>
        </div>
        <div style="font-size:13px;margin-top:4px;">${r.text}</div>
      </div>`
    ).join('');

  openModal('searchModal');
}

document.getElementById('globalSearch').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { globalSearch(e.target.value); }
});

// ============================================================
// UTILITIES
// ============================================================
function formatDate(d) {
  if (!d) return 'â€”';
  const date = new Date(d + 'T00:00:00');
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function formatDateShort(d) {
  if (!d) return '';
  const date = new Date(d + 'T00:00:00');
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function chartOpts(y1Label, y2Label) {
  return {
    responsive: true,
    interaction: { mode: 'index', intersect: false },
    plugins: { legend: { labels: { color: '#8b8fa8', font: { family: 'DM Sans', size: 11 } } } },
    scales: {
      x: { ticks: { color: '#5c6078', font: { family: 'DM Sans', size: 10 } }, grid: { color: 'rgba(46,49,72,0.3)' } },
      y: { ticks: { color: '#5c6078', font: { family: 'DM Sans', size: 10 } }, grid: { color: 'rgba(46,49,72,0.3)' }, title: { display: true, text: y1Label, color: '#8b8fa8', font: { size: 11 } } },
      y2: { position: 'right', ticks: { color: '#5c6078', font: { family: 'DM Sans', size: 10 } }, grid: { display: false }, title: { display: true, text: y2Label, color: '#8b8fa8', font: { size: 11 } } }
    }
  };
}

function simpleChartOpts() {
  return {
    responsive: true,
    plugins: { legend: { labels: { color: '#8b8fa8', font: { family: 'DM Sans', size: 11 } } } },
    scales: {
      x: { ticks: { color: '#5c6078', font: { family: 'DM Sans', size: 10 } }, grid: { color: 'rgba(46,49,72,0.3)' } },
      y: { ticks: { color: '#5c6078', font: { family: 'DM Sans', size: 10 } }, grid: { color: 'rgba(46,49,72,0.3)' } }
    }
  };
}

function updateBadges() {
  document.getElementById('weightCount').textContent = APP.weight.length;
  document.getElementById('glucoseCount').textContent = APP.glucose.length;
  document.getElementById('exerciseCount').textContent = APP.exercise.length;
  document.getElementById('fastingCount').textContent = APP.fasting.length;
  document.getElementById('journalCount').textContent = APP.journal.length;
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
let lastKey = '';
document.addEventListener('keydown', (e) => {
  // Don't trigger in inputs
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
    if (e.key === 'Escape') e.target.blur();
    return;
  }

  if (e.ctrlKey && e.key === 'k') { e.preventDefault(); document.getElementById('globalSearch').focus(); return; }

  if (lastKey === 'n') {
    switch(e.key.toLowerCase()) {
      case 'w': openWeightModal(); break;
      case 'g': openGlucoseModal(); break;
      case 'e': openExerciseModal(); break;
      case 'f': openFastingModal(); break;
      case 'j': openJournalModal(); break;
    }
    lastKey = '';
    return;
  }
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
  }
  lastKey = e.key.toLowerCase();
  setTimeout(() => { lastKey = ''; }, 500);
});

// ============================================================
// AUTO-SAVE
// ============================================================
setInterval(() => {
  saveData();
}, 60000);

// ============================================================
// INIT
// ============================================================
function init() {
  updateBadges();
  renderDashboard();
  restoreTimer();
}

init();
</script>
</body>
</html>
